<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¡¨æƒ…è®­ç»ƒæ•™ç»ƒ - ä¸“ä¸šç‰ˆ</title>
    <!--
    æœ¬åœ°è¿è¡Œè¯´æ˜ï¼š
    1. æ‘„åƒå¤´éœ€è¦ HTTPS æˆ– localhostï¼Œä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æœ¬åœ°èµ·æœåŠ¡ï¼š
       python -m http.server 8000
       ç„¶åè®¿é—® http://localhost:8000
    
    2. æˆ–ä½¿ç”¨ Python 3:
       python3 -m http.server 8000
       
    3. æ‰€æœ‰è®¡ç®—åœ¨æœ¬åœ°å®Œæˆï¼Œä¸ä¸Šä¼ ä»»ä½•å›¾åƒè§†é¢‘æ•°æ®
    -->
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #ffffff;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* æ­¥éª¤å®¹å™¨æ ·å¼ */
        .step-container {
            display: none;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border-radius: 24px;
            padding: 40px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            text-align: center;
        }
        
        .step-container.active {
            display: block;
            animation: slideInUp 0.6s ease-out;
        }
        
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* æ­¥éª¤æ ‡é¢˜ */
        .step-title {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #4ecdc4, #45b7d1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .step-subtitle {
            font-size: 18px;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 30px;
        }
        
        /* æ­¥éª¤è¿›åº¦æŒ‡ç¤ºå™¨ */
        .step-progress {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 40px;
            gap: 20px;
        }
        
        .progress-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }
        
        .progress-dot.active {
            background: #4ecdc4;
            transform: scale(1.5);
            box-shadow: 0 0 20px rgba(78, 205, 196, 0.6);
        }
        
        .progress-dot.completed {
            background: #96ceb4;
        }
        
        /* æ¬¢è¿å±å¹• */
        .welcome-content {
            max-width: 600px;
            margin: 0 auto;
        }
        
        .welcome-icon {
            font-size: 80px;
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .feature-list {
            text-align: left;
            margin: 30px 0;
            background: rgba(0, 0, 0, 0.2);
            padding: 25px;
            border-radius: 16px;
        }
        
        .feature-item {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            font-size: 16px;
        }
        
        .feature-icon {
            font-size: 24px;
            margin-right: 15px;
            width: 40px;
        }
        
        /* è®¾ç½®å±å¹• */
        .mode-selection {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin: 30px 0;
        }
        
        .mode-card {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .mode-card:hover {
            transform: translateY(-5px);
            border-color: #4ecdc4;
            box-shadow: 0 10px 30px rgba(78, 205, 196, 0.3);
        }
        
        .mode-card.selected {
            border-color: #4ecdc4;
            background: rgba(78, 205, 196, 0.2);
        }
        
        .mode-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        .mode-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .mode-description {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            line-height: 1.5;
        }
        
        /* æ ¡å‡†å±å¹• */
        .calibration-content {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .video-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin: 0 auto 30px;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }
        
        .beauty-controls {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            z-index: 20;
        }
        
        .beauty-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .beauty-switch {
            position: relative;
            width: 50px;
            height: 26px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .beauty-switch.active {
            background: #4ecdc4;
        }
        
        .beauty-switch-knob {
            position: absolute;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: all 0.3s ease;
        }
        
        .beauty-switch.active .beauty-switch-knob {
            transform: translateX(24px);
        }
        
        .beauty-label {
            font-size: 12px;
            color: #fff;
            font-weight: 500;
        }
        
        .beauty-slider {
            display: none;
            margin-bottom: 8px;
        }
        
        .beauty-slider.active {
            display: block;
        }
        
        .beauty-slider input {
            width: 100px;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            outline: none;
            -webkit-appearance: none;
        }
        
        .beauty-slider input::-webkit-slider-thumb {
            width: 14px;
            height: 14px;
            background: #4ecdc4;
            border-radius: 50%;
            cursor: pointer;
            -webkit-appearance: none;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }
        
        .beauty-slider-label {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 4px;
        }
        
        .video-wrapper {
            position: relative;
            width: 100%;
            height: 400px;
            background: #000;
        }
        
        #videoElement,
        #videoElement2,
        #videoElement3 {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }
        
        #videoElement,
        #videoElement2,
        #videoElement3,
        #beautifiedCanvas,
        #beautifiedCanvas2,
        #beautifiedCanvas3 {
            transform: scaleX(-1);
        }
        
        #beautifiedCanvas,
        #beautifiedCanvas2,
        #beautifiedCanvas3 {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 2;
            pointer-events: none;
        }
        
        #overlayCanvas,
        #overlayCanvas2,
        #overlayCanvas3 {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 3;
        }
        
        .video-status {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(0, 0, 0, 0.8);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .countdown-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 120px;
            font-weight: bold;
            color: #4ecdc4;
            text-shadow: 2px 2px 10px rgba(0, 0, 0, 0.8);
            z-index: 10;
            display: none;
        }
        
        .countdown-overlay.show {
            display: block;
            animation: countdownPulse 1s ease-out;
        }
        
        @keyframes countdownPulse {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        
        /* è®­ç»ƒå±å¹• */
        .training-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 40px;
            align-items: start;
        }
        
        @media (max-width: 1200px) {
            .training-content {
                grid-template-columns: 1fr;
            }
        }
        
        .expression-guide {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
        }
        
        .expression-demo {
            font-size: 80px;
            margin-bottom: 20px;
            animation: expressionDemo 2s ease-in-out infinite;
        }
        
        @keyframes expressionDemo {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .expression-text {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #4ecdc4;
        }
        
        .expression-tips {
            font-size: 16px;
            line-height: 1.6;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 30px;
        }
        
        .training-progress {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            height: 8px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .training-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ecdc4, #45b7d1);
            width: 0%;
            transition: width 0.1s ease;
        }
        
        /* ç»“æœå±å¹• */
        .results-content {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .score-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .score-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 25px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .score-card.excellent {
            border-color: #4ecdc4;
            background: rgba(78, 205, 196, 0.2);
        }
        
        .score-card.good {
            border-color: #45b7d1;
            background: rgba(69, 183, 209, 0.2);
        }
        
        .score-card.needs-work {
            border-color: #ff6b6b;
            background: rgba(255, 107, 107, 0.2);
        }
        
        .score-icon {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .score-label {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 8px;
        }
        
        .score-value {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .score-change {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 12px;
            background: rgba(0, 0, 0, 0.3);
        }
        
        .feedback-section {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
        }
        
        .feedback-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #4ecdc4;
        }
        
        .feedback-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
        }
        
        .feedback-icon {
            font-size: 20px;
            margin-right: 15px;
            margin-top: 2px;
        }
        
        .feedback-text {
            flex: 1;
            line-height: 1.5;
        }
        
        /* æŒ‰é’®æ ·å¼ */
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #4ecdc4, #45b7d1);
            color: #ffffff;
            min-width: 200px;
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: #ffffff;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .btn-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }
        
        /* ç”Ÿæˆè§†é¢‘æŒ‰é’®ç‰¹æ®Šæ ·å¼ */
        #makeShareVideoBtn {
            background: linear-gradient(45deg, #ff6b6b, #ff8e8e);
            font-size: 18px;
            padding: 18px 35px;
            box-shadow: 0 4px 20px rgba(255, 107, 107, 0.3);
        }
        
        #makeShareVideoBtn:hover {
            background: linear-gradient(45deg, #ff5252, #ff7979);
            box-shadow: 0 6px 25px rgba(255, 107, 107, 0.4);
        }
        
        /* åŠ¨ç”»å’Œæ•ˆæœ */
        .celebration {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }
        
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #4ecdc4;
            animation: confetti 3s ease-out forwards;
        }
        
        @keyframes confetti {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }
        
        /* çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .status-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 500;
            z-index: 100;
            backdrop-filter: blur(10px);
        }
        
        .status-ready {
            background: rgba(150, 206, 180, 0.9);
            color: #ffffff;
        }
        
        .status-running {
            background: rgba(78, 205, 196, 0.9);
            color: #ffffff;
            animation: pulse 1.5s infinite;
        }
        
        .status-error {
            background: rgba(255, 107, 107, 0.9);
            color: #ffffff;
        }
        
        /* è¯­è¨€åˆ‡æ¢ */
        .language-switcher {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 100;
        }
        
        .lang-link {
            display: inline-block;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            color: #ffffff;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        
        .lang-link:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .app-container {
                padding: 15px;
            }
            
            .step-container {
                padding: 25px;
            }
            
            .step-title {
                font-size: 24px;
            }
            
            .mode-selection {
                grid-template-columns: 1fr;
            }
            
            .training-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .score-display {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- è¯­è¨€åˆ‡æ¢ -->
        <div class="language-switcher">
            <a href="./index-en.html" class="lang-link">ğŸ‡ºğŸ‡¸ English</a>
        </div>
        
        <!-- çŠ¶æ€æŒ‡ç¤ºå™¨ -->
        <div class="status-indicator" id="statusIndicator">åˆå§‹åŒ–ä¸­...</div>
        
        <!-- æ­¥éª¤1: æ¬¢è¿å±å¹• -->
        <div class="step-container active" id="welcomeStep">
            <div class="step-progress">
                <div class="progress-dot active"></div>
                <div class="progress-dot"></div>
                <div class="progress-dot"></div>
                <div class="progress-dot"></div>
                <div class="progress-dot"></div>
            </div>
            
            <div class="welcome-content">
                <div class="welcome-icon">ğŸ­</div>
                <h1 class="step-title">è¡¨æƒ…è®­ç»ƒæ•™ç»ƒ</h1>
                <p class="step-subtitle">AIé©±åŠ¨çš„ä¸“ä¸šè¡¨æ¼”è®­ç»ƒç³»ç»Ÿ</p>
                
                <div class="feature-list">
                    <div class="feature-item">
                        <span class="feature-icon">ğŸ¬</span>
                        <span>å½±è§†é•œå¤´ vs èˆå°è¡¨æ¼”æ¨¡å¼</span>
                    </div>
                    <div class="feature-item">
                        <span class="feature-icon">ğŸ“Š</span>
                        <span>å››ç»´ä¸“ä¸šè¯„åˆ†ç³»ç»Ÿ</span>
                    </div>
                    <div class="feature-item">
                        <span class="feature-icon">ğŸ¯</span>
                        <span>ä¸ªäººåŒ–æ ¡å‡†ä¸åé¦ˆ</span>
                    </div>
                    <div class="feature-item">
                        <span class="feature-icon">âœ¨</span>
                        <span>æ™ºèƒ½ç¾é¢œï¼Œæå‡è‡ªä¿¡</span>
                    </div>
                    <div class="feature-item">
                        <span class="feature-icon">ğŸ”’</span>
                        <span>æœ¬åœ°è®¡ç®—ï¼Œä¿æŠ¤éšç§</span>
                    </div>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="nextStep()">å¼€å§‹è®­ç»ƒ</button>
                </div>
            </div>
        </div>
        
        <!-- æ­¥éª¤2: æ¨¡å¼é€‰æ‹© -->
        <div class="step-container" id="modeStep">
            <div class="step-progress">
                <div class="progress-dot completed"></div>
                <div class="progress-dot active"></div>
                <div class="progress-dot"></div>
                <div class="progress-dot"></div>
                <div class="progress-dot"></div>
            </div>
            
            <h2 class="step-title">é€‰æ‹©è¡¨æ¼”æ¨¡å¼</h2>
            <p class="step-subtitle">ä¸åŒæ¨¡å¼å°†å½±å“è¯„åˆ†æ ‡å‡†å’Œè®­ç»ƒé‡ç‚¹</p>
            
            <div class="mode-selection">
                <div class="mode-card" onclick="selectMode('film')">
                    <div class="mode-icon">ğŸ¬</div>
                    <div class="mode-title">å½±è§†é•œå¤´</div>
                    <div class="mode-description">
                        é€‚åˆè¿‘è·ç¦»é•œå¤´æ‹æ‘„ï¼Œæ³¨é‡è¡¨æƒ…çš„ç»†è…»åº¦å’ŒçœŸå®æ„Ÿã€‚è¿‡åº¦å¤¸å¼ ä¼šè¢«æ‰£åˆ†ã€‚
                    </div>
                </div>
                
                <div class="mode-card" onclick="selectMode('stage')">
                    <div class="mode-icon">ğŸ­</div>
                    <div class="mode-title">èˆå°è¡¨æ¼”</div>
                    <div class="mode-description">
                        é€‚åˆèˆå°æ¼”å‡ºï¼Œéœ€è¦æ¸…æ™°å¯è§çš„è¡¨æƒ…å¹…åº¦ï¼Œè®©åæ’è§‚ä¼—ä¹Ÿèƒ½çœ‹æ¸…ã€‚
                    </div>
                </div>
            </div>
            
            <div class="btn-group">
                <button class="btn btn-secondary" onclick="prevStep()">è¿”å›</button>
                <button class="btn btn-primary" id="modeNextBtn" onclick="nextStep()" disabled>ä¸‹ä¸€æ­¥</button>
            </div>
        </div>
        
        <!-- æ­¥éª¤3: æ‘„åƒå¤´å‡†å¤‡ -->
        <div class="step-container" id="cameraStep">
            <div class="step-progress">
                <div class="progress-dot completed"></div>
                <div class="progress-dot completed"></div>
                <div class="progress-dot active"></div>
                <div class="progress-dot"></div>
                <div class="progress-dot"></div>
            </div>
            
            <h2 class="step-title">æ‘„åƒå¤´å‡†å¤‡</h2>
            <p class="step-subtitle">è¯·å…è®¸æ‘„åƒå¤´è®¿é—®æƒé™ï¼Œç¡®ä¿é¢éƒ¨æ¸…æ™°å¯è§</p>
            
            <div class="calibration-content">
                <div class="video-container">
                    <div class="video-wrapper">
                        <video id="videoElement" autoplay muted playsinline></video>
                        <canvas id="beautifiedCanvas"></canvas>
                        <canvas id="overlayCanvas"></canvas>
                        <div class="video-status" id="videoStatus">æ£€æµ‹ä¸­...</div>
                        <div class="countdown-overlay" id="countdownOverlay">3</div>
                        
                        <div class="beauty-controls">
                            <div class="beauty-toggle">
                                <div class="beauty-switch" id="beautySwitch" onclick="toggleBeauty()">
                                    <div class="beauty-switch-knob"></div>
                                </div>
                                <span class="beauty-label">ç¾é¢œ</span>
                            </div>
                            
                            
                            <div class="beauty-slider" id="smoothSlider">
                                <div class="beauty-slider-label">ç£¨çš®</div>
                                <input type="range" min="0" max="100" value="50" id="smoothRange" oninput="updateBeauty()">
                            </div>
                            
                            <div class="beauty-slider" id="brightnessSlider">
                                <div class="beauty-slider-label">äº®åº¦</div>
                                <input type="range" min="-50" max="50" value="10" id="brightnessRange" oninput="updateBeauty()">
                            </div>
                            
                            <div class="beauty-slider" id="contrastSlider">
                                <div class="beauty-slider-label">å¯¹æ¯”</div>
                                <input type="range" min="-50" max="50" value="15" id="contrastRange" oninput="updateBeauty()">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="feature-list" style="text-align: center;">
                    <div class="feature-item" style="justify-content: center;">
                        <span class="feature-icon">ğŸ’¡</span>
                        <span>ç¡®ä¿å…‰çº¿å……è¶³ï¼Œé¿å…èƒŒå…‰</span>
                    </div>
                    <div class="feature-item" style="justify-content: center;">
                        <span class="feature-icon">ğŸ‘¤</span>
                        <span>ä¿æŒæ­£é¢æœå‘æ‘„åƒå¤´</span>
                    </div>
                    <div class="feature-item" style="justify-content: center;">
                        <span class="feature-icon">ğŸ“</span>
                        <span>å¤´éƒ¨å æ®ç”»é¢1/3å·¦å³</span>
                    </div>
                </div>
            </div>
            
            <div class="btn-group">
                <button class="btn btn-secondary" onclick="prevStep()">è¿”å›</button>
                <button class="btn btn-primary" id="cameraNextBtn" onclick="nextStep()" disabled>å¼€å§‹æ ¡å‡†</button>
            </div>
        </div>
        
        <!-- æ­¥éª¤4: ä¸ªäººæ ¡å‡† -->
        <div class="step-container" id="calibrationStep">
            <div class="step-progress">
                <div class="progress-dot completed"></div>
                <div class="progress-dot completed"></div>
                <div class="progress-dot completed"></div>
                <div class="progress-dot active"></div>
                <div class="progress-dot"></div>
            </div>
            
            <h2 class="step-title">ä¸ªäººåŒ–æ ¡å‡†</h2>
            <p class="step-subtitle">ä¿æŒä¸­æ€§è¡¨æƒ…2ç§’é’Ÿï¼Œå»ºç«‹æ‚¨çš„é¢éƒ¨åŸºçº¿</p>
            
            <div class="calibration-content">
                <div class="video-container">
                    <div class="video-wrapper">
                        <video id="videoElement2" autoplay muted playsinline></video>
                        <canvas id="beautifiedCanvas2"></canvas>
                        <canvas id="overlayCanvas2"></canvas>
                        <div class="video-status" id="videoStatus2">å‡†å¤‡æ ¡å‡†...</div>
                        <div class="countdown-overlay" id="countdownOverlay2">å‡†å¤‡</div>
                        
                        <div class="beauty-controls">
                            <div class="beauty-toggle">
                                <div class="beauty-switch" id="beautySwitch2" onclick="toggleBeauty()">
                                    <div class="beauty-switch-knob"></div>
                                </div>
                                <span class="beauty-label">ç¾é¢œ</span>
                            </div>
                            
                            <div class="beauty-slider" id="smoothSlider2">
                                <div class="beauty-slider-label">ç£¨çš®</div>
                                <input type="range" min="0" max="100" value="50" id="smoothRange2" oninput="updateBeauty()">
                            </div>
                            
                            <div class="beauty-slider" id="brightnessSlider2">
                                <div class="beauty-slider-label">äº®åº¦</div>
                                <input type="range" min="-50" max="50" value="10" id="brightnessRange2" oninput="updateBeauty()">
                            </div>
                            
                            <div class="beauty-slider" id="contrastSlider2">
                                <div class="beauty-slider-label">å¯¹æ¯”</div>
                                <input type="range" min="-50" max="50" value="15" id="contrastRange2" oninput="updateBeauty()">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="training-progress">
                    <div class="training-progress-fill" id="calibrationProgress"></div>
                </div>
                
                <div id="calibrationInstructions" class="expression-tips">
                    ä¿æŒæ”¾æ¾çš„ä¸­æ€§è¡¨æƒ…ï¼Œä¸è¦å¾®ç¬‘æˆ–çš±çœ‰
                </div>
            </div>
            
            <div class="btn-group">
                <button class="btn btn-secondary" onclick="prevStep()">è¿”å›</button>
                <button class="btn btn-primary" id="calibrationBtn" onclick="startCalibration()">å¼€å§‹æ ¡å‡†</button>
            </div>
        </div>
        
        <!-- æ­¥éª¤5: è¡¨æƒ…è®­ç»ƒ -->
        <div class="step-container" id="trainingStep">
            <div class="step-progress">
                <div class="progress-dot completed"></div>
                <div class="progress-dot completed"></div>
                <div class="progress-dot completed"></div>
                <div class="progress-dot completed"></div>
                <div class="progress-dot active"></div>
            </div>
            
            <h2 class="step-title">è¡¨æƒ…è®­ç»ƒ</h2>
            <p class="step-subtitle" id="trainingSubtitle">è·ŸéšæŒ‡å¯¼å®Œæˆè¡¨æƒ…ç»ƒä¹ </p>
            
            <div class="training-content">
                <div class="video-container">
                    <div class="video-wrapper">
                        <video id="videoElement3" autoplay muted playsinline></video>
                        <canvas id="beautifiedCanvas3"></canvas>
                        <canvas id="overlayCanvas3"></canvas>
                        <div class="video-status" id="videoStatus3">å‡†å¤‡è®­ç»ƒ...</div>
                        <div class="countdown-overlay" id="countdownOverlay3">3</div>
                        
                        <div class="beauty-controls">
                            <div class="beauty-toggle">
                                <div class="beauty-switch" id="beautySwitch3" onclick="toggleBeauty()">
                                    <div class="beauty-switch-knob"></div>
                                </div>
                                <span class="beauty-label">ç¾é¢œ</span>
                            </div>
                            
                            <div class="beauty-slider" id="smoothSlider3">
                                <div class="beauty-slider-label">ç£¨çš®</div>
                                <input type="range" min="0" max="100" value="50" id="smoothRange3" oninput="updateBeauty()">
                            </div>
                            
                            <div class="beauty-slider" id="brightnessSlider3">
                                <div class="beauty-slider-label">äº®åº¦</div>
                                <input type="range" min="-50" max="50" value="10" id="brightnessRange3" oninput="updateBeauty()">
                            </div>
                            
                            <div class="beauty-slider" id="contrastSlider3">
                                <div class="beauty-slider-label">å¯¹æ¯”</div>
                                <input type="range" min="-50" max="50" value="15" id="contrastRange3" oninput="updateBeauty()">
                            </div>
                        </div>
                    </div>
                    
                    <div class="training-progress">
                        <div class="training-progress-fill" id="trainingProgress"></div>
                    </div>
                </div>
                
                <div class="expression-guide">
                    <div class="expression-demo" id="expressionDemo">ğŸ˜Š</div>
                    <div class="expression-text" id="expressionText">è‡ªç„¶å¾®ç¬‘</div>
                    <div class="expression-tips" id="expressionTips">
                        å˜´è§’è‡ªç„¶ä¸Šæ‰¬ï¼Œä¿æŒ2ç§’é’Ÿ
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn btn-secondary" id="skipBtn" onclick="nextExpression()">è·³è¿‡</button>
                        <button class="btn btn-primary" id="startTrainingBtn" onclick="startExpression()">å¼€å§‹</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ç»“æœå±å¹• -->
        <div class="step-container" id="resultsStep">
            <h2 class="step-title">è®­ç»ƒç»“æœ</h2>
            <p class="step-subtitle" id="resultSubtitle">æ‚¨åœ¨å½±è§†é•œå¤´æ¨¡å¼ä¸‹çš„è¡¨ç°</p>
            
            <div class="results-content">
                <div class="score-display">
                    <div class="score-card" id="clarityCard">
                        <div class="score-icon">ğŸ¯</div>
                        <div class="score-label">æ¸…æ™°åº¦</div>
                        <div class="score-value" id="clarityValue">85</div>
                        <div class="score-change" id="clarityChange">+5</div>
                    </div>
                    
                    <div class="score-card" id="consistencyCard">
                        <div class="score-icon">âš–ï¸</div>
                        <div class="score-label">ä¸€è‡´æ€§</div>
                        <div class="score-value" id="consistencyValue">92</div>
                        <div class="score-change" id="consistencyChange">+3</div>
                    </div>
                    
                    <div class="score-card" id="intensityCard">
                        <div class="score-icon">âš¡</div>
                        <div class="score-label">å¼ºåº¦</div>
                        <div class="score-value" id="intensityValue">78</div>
                        <div class="score-change" id="intensityChange">-2</div>
                    </div>
                    
                    <div class="score-card" id="truthCard">
                        <div class="score-icon">ğŸ’«</div>
                        <div class="score-label">çœŸå®æ€§</div>
                        <div class="score-value" id="truthValue">88</div>
                        <div class="score-change" id="truthChange">+7</div>
                    </div>
                </div>
                
                <div class="feedback-section">
                    <div class="feedback-title">ğŸ’¡ ä¸“ä¸šæŒ‡å¯¼å»ºè®®</div>
                    <div id="feedbackContainer">
                        <div class="feedback-item">
                            <div class="feedback-icon">âœ¨</div>
                            <div class="feedback-text">è¡¨ç°ä¼˜ç§€ï¼è¡¨æƒ…è‡ªç„¶çœŸå®ï¼Œç»§ç»­ä¿æŒè¿™ç§çŠ¶æ€ã€‚</div>
                        </div>
                        <div class="feedback-item">
                            <div class="feedback-icon">ğŸ­</div>
                            <div class="feedback-text">å½±è§†è¡¨æ¼”é£æ ¼æŒæ¡ä¸é”™ï¼Œå¯ä»¥å°è¯•æ›´æœ‰æŒ‘æˆ˜çš„è¡¨æƒ…ã€‚</div>
                        </div>
                    </div>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-primary" id="makeShareVideoBtn">ğŸ¥ ç”Ÿæˆåˆ†äº«è§†é¢‘</button>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="restartTraining()">ğŸ”„ é‡æ–°è®­ç»ƒ</button>
                    <button class="btn btn-primary" onclick="continueTraining()">â• ç»§ç»­ç»ƒä¹ </button>
                </div>
            </div>
        </div>
        
        <!-- åº†ç¥åŠ¨ç”»å®¹å™¨ -->
        <div class="celebration" id="celebrationContainer"></div>
    </div>

    <script>
        // è®­ç»ƒå£ä»¤é…ç½®
        const TRAINING_COMMANDS = {
            smile_natural: {
                id: "smile_natural",
                text: "è¯·åšè‡ªç„¶å¾®ç¬‘å¹¶ä¿æŒä¸¤ç§’",
                emoji: "ğŸ˜Š",
                tips: "å˜´è§’è‡ªç„¶ä¸Šæ‰¬ï¼Œçœ¼ç¥æ¸©å’Œ",
                tts: true,
                duration: 2000,
                target: "smile",
                duchenne: false,
                difficulty: "E"
            },
            smile_duchenne: {
                id: "smile_duchenne", 
                text: "è¯·åšå¸¦çœ¼ç¬‘å¹¶ä¿æŒä¸¤ç§’",
                emoji: "ğŸ˜„",
                tips: "çœ¼è§’å¾®çœ¯ï¼Œå˜´è§’ä¸Šæ‰¬ï¼ŒçœŸè¯šå¿«ä¹",
                tts: true,
                duration: 2000,
                target: "smile",
                duchenne: true,
                difficulty: "M"
            },
            surprised: {
                id: "surprised",
                text: "è¯·åšæƒŠè®¶è¡¨æƒ…",
                emoji: "ğŸ˜®",
                tips: "å¼ å£çªçœ¼ï¼Œçœ‰æ¯›ä¸Šæ‰¬",
                tts: true,
                duration: 1500,
                target: "surprised",
                duchenne: false,
                difficulty: "M"
            },
            sad: {
                id: "sad",
                text: "è¯·åšæ‚²ä¼¤è¡¨æƒ…",
                emoji: "ğŸ˜¢",
                tips: "çœ‰å¿ƒå†…æ”¶ï¼Œå˜´è§’ä¸‹å‚",
                tts: true,
                duration: 2000,
                target: "sad",
                duchenne: false,
                difficulty: "H"
            },
            angry: {
                id: "angry",
                text: "è¯·åšæ„¤æ€’è¡¨æƒ…",
                emoji: "ğŸ˜ ",
                tips: "çœ‰æ¯›å‹ä½ï¼Œç›®å…‰é›†ä¸­",
                tts: true,
                duration: 2000,
                target: "angry",
                duchenne: false,
                difficulty: "H"
            }
        };

        // å…¨å±€å˜é‡
        let faceMesh;
        let camera;
        let currentStep = 0;
        let selectedMode = null;
        let isRunning = false;
        let isCalibrating = false;
        let currentSession = null;
        let baseline = null;
        let metricsBuffer = [];
        let lastFrameTime = 0;
        let frameCount = 0;
        let currentExpressionIndex = 0;
        let trainingSequence = ['smile_natural', 'smile_duchenne', 'surprised', 'sad', 'angry'];
        let countdownTimer = null;
        let trainingTimer = null;
        
        // ç¾é¢œç›¸å…³å˜é‡
        let beautyEnabled = false;
        let beautySettings = {
            smooth: 50,
            brightness: 10,
            contrast: 15
        };
        
        // DOM å…ƒç´ è·å–
        const steps = ['welcomeStep', 'modeStep', 'cameraStep', 'calibrationStep', 'trainingStep'];
        const videoElements = ['videoElement', 'videoElement2', 'videoElement3'];
        const overlayCanvases = ['overlayCanvas', 'overlayCanvas2', 'overlayCanvas3'];
        
        // MediaPipe å…³é”®ç‚¹ç´¢å¼•
        const LANDMARKS = {
            MOUTH: {
                LEFT_CORNER: 61,
                RIGHT_CORNER: 291,
                TOP: 13,
                BOTTOM: 14,
                UPPER_LIP: [12, 15, 16, 17, 18, 200],
                LOWER_LIP: [146, 91, 181, 84, 17, 314, 405, 320, 307, 375]
            },
            LEFT_EYE: {
                TOP: 159,
                BOTTOM: 145,
                LEFT: 33,
                RIGHT: 133,
                OUTLINE: [33, 7, 163, 144, 145, 153, 154, 155, 133, 173, 157, 158, 159, 160, 161, 246]
            },
            RIGHT_EYE: {
                TOP: 386,
                BOTTOM: 374,
                LEFT: 362,
                RIGHT: 263,
                OUTLINE: [362, 382, 381, 380, 374, 373, 390, 249, 263, 466, 388, 387, 386, 385, 384, 398]
            },
            LEFT_EYEBROW: {
                INNER: 55,
                OUTER: 46,
                CENTER: 70
            },
            RIGHT_EYEBROW: {
                INNER: 285,
                OUTER: 276,
                CENTER: 300
            },
            NOSE_TIP: 1
        };

        // æ­¥éª¤å¯¼èˆªå‡½æ•°
        async function nextStep() {
            if (currentStep < steps.length - 1) {
                document.getElementById(steps[currentStep]).classList.remove('active');
                currentStep++;
                document.getElementById(steps[currentStep]).classList.add('active');
                
                // ç‰¹æ®Šå¤„ç†
                if (currentStep === 2) { // æ‘„åƒå¤´å‡†å¤‡æ­¥éª¤
                    initializeCamera();
                } else if (currentStep === 3) { // æ ¡å‡†æ­¥éª¤
                    await setupCalibrationVideo();
                } else if (currentStep === 4) { // è®­ç»ƒæ­¥éª¤
                    await setupTrainingVideo();
                }
            }
        }

        function prevStep() {
            if (currentStep > 0) {
                document.getElementById(steps[currentStep]).classList.remove('active');
                currentStep--;
                document.getElementById(steps[currentStep]).classList.add('active');
            }
        }

        // æ¨¡å¼é€‰æ‹©
        function selectMode(mode) {
            selectedMode = mode;
            
            // æ›´æ–°UI
            document.querySelectorAll('.mode-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            event.target.closest('.mode-card').classList.add('selected');
            document.getElementById('modeNextBtn').disabled = false;
        }

        // çŠ¶æ€æ›´æ–°
        function updateStatus(message, type = 'ready') {
            const indicator = document.getElementById('statusIndicator');
            indicator.textContent = message;
            indicator.className = `status-indicator status-${type}`;
        }

        // æ‘„åƒå¤´åˆå§‹åŒ–
        async function initializeCamera() {
            try {
                updateStatus('å¯åŠ¨æ‘„åƒå¤´...', 'running');
                
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        width: 640, 
                        height: 480,
                        facingMode: 'user'
                    }
                });
                
                // ä¸ºæ‰€æœ‰è§†é¢‘å…ƒç´ è®¾ç½®æµ
                videoElements.forEach(id => {
                    const video = document.getElementById(id);
                    if (video) {
                        video.srcObject = stream;
                        video.onloadedmetadata = () => {
                            const canvasId = id.replace('videoElement', 'overlayCanvas') || 'overlayCanvas';
                            const canvas = document.getElementById(canvasId);
                            if (canvas) {
                                canvas.width = video.videoWidth;
                                canvas.height = video.videoHeight;
                            }
                        };
                    }
                });
                
                await initializeFaceMesh();
                updateStatus('æ‘„åƒå¤´å°±ç»ª', 'ready');
                document.getElementById('cameraNextBtn').disabled = false;
                
            } catch (error) {
                console.error('æ‘„åƒå¤´åˆå§‹åŒ–å¤±è´¥:', error);
                updateStatus('æ‘„åƒå¤´è®¿é—®å¤±è´¥', 'error');
            }
        }

        async function initializeFaceMesh() {
            faceMesh = new FaceMesh({
                locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`
            });

            faceMesh.setOptions({
                maxNumFaces: 1,
                refineLandmarks: true,
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });

            faceMesh.onResults(onFaceMeshResults);

            // åˆå§‹ç›¸æœºè®¾ç½®ç”¨äºæ‘„åƒå¤´æµ‹è¯•æ­¥éª¤
            camera = new Camera(document.getElementById('videoElement'), {
                onFrame: async () => {
                    const video = document.getElementById('videoElement');
                    if (video && video.videoWidth > 0) {
                        await faceMesh.send({image: video});
                    }
                },
                width: 640,
                height: 480
            });

            camera.start();
        }

        function getCurrentVideo() {
            const activeStep = document.querySelector('.step-container.active');
            if (activeStep) {
                const video = activeStep.querySelector('video');
                if (isCalibrating && video) {
                    console.log('æ ¡å‡†ä¸­è·å–è§†é¢‘å…ƒç´ :', video.id, 'from step:', activeStep.id);
                }
                return video;
            }
            return document.getElementById('videoElement');
        }
        
        function getCurrentProcessedCanvas() {
            const activeStep = document.querySelector('.step-container.active');
            if (activeStep) {
                const canvas = activeStep.querySelector('[id*="beautifiedCanvas"]');
                if (isCalibrating) {
                    console.log('æ ¡å‡†ä¸­è·å–canvas:', canvas ? canvas.id : 'null', 'activeStep:', activeStep.id);
                }
                return canvas;
            }
            return document.getElementById('beautifiedCanvas');
        }

        function getCurrentCanvas() {
            const activeStep = document.querySelector('.step-container.active');
            if (activeStep) {
                const canvas = activeStep.querySelector('canvas');
                return canvas;
            }
            return document.getElementById('overlayCanvas');
        }

        function onFaceMeshResults(results) {
            const now = performance.now();
            
            // è°ƒè¯•ï¼šæ ¡å‡†æœŸé—´MediaPipeæ˜¯å¦åœ¨å·¥ä½œ
            if (isCalibrating && Math.random() < 0.1) { // 10%æ¦‚ç‡æ‰“å°
                console.log('MediaPipe onFaceMeshResults è¢«è°ƒç”¨ï¼Œlandmarks:', results.multiFaceLandmarks?.length || 0);
            }
            
            // æ›´æ–°FPS (ç®€åŒ–ç‰ˆ)
            frameCount++;
            if (now - lastFrameTime >= 1000) {
                lastFrameTime = now;
                frameCount = 0;
            }

            // è·å–å½“å‰æ´»åŠ¨çš„canvas
            const canvas = getCurrentCanvas();
            if (!canvas) {
                if (isCalibrating) {
                    console.error('æ ¡å‡†ä¸­æ— æ³•è·å–å½“å‰canvas');
                }
                return;
            }
            
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
                const landmarks = results.multiFaceLandmarks[0];
                
                // ç»˜åˆ¶è¦†ç›–å±‚
                drawOverlay(ctx, landmarks, canvas);
                
                // æå–ç‰¹å¾
                const metrics = extractMetrics(landmarks);
                
                // æ”¶é›†è®­ç»ƒæ•°æ®
                if ((isRunning || isCalibrating) && metrics) {
                    metricsBuffer.push({
                        timestamp: now,
                        metrics: metrics
                    });
                    
                    // è°ƒè¯•ä¿¡æ¯
                    if (isCalibrating && metricsBuffer.length % 5 === 0) {
                        console.log(`æ ¡å‡†è¿›è¡Œä¸­ï¼Œå·²æ”¶é›† ${metricsBuffer.length} ä¸ªæ•°æ®ç‚¹`, metrics);
                    }
                } else if (isCalibrating) {
                    // è°ƒè¯•ï¼šå¦‚æœåœ¨æ ¡å‡†ä½†æ²¡æœ‰æ”¶é›†åˆ°æ•°æ®
                    console.log('æ ¡å‡†ä¸­ä½†æœªæ”¶é›†åˆ°æœ‰æ•ˆæ•°æ®ï¼Œmetrics:', metrics);
                }
                
                // æ›´æ–°è§†é¢‘çŠ¶æ€
                updateVideoStatus(true);
            } else {
                // è°ƒè¯•ï¼šæ ¡å‡†æœŸé—´æœªæ£€æµ‹åˆ°é¢éƒ¨
                if (isCalibrating) {
                    console.log('æ ¡å‡†ä¸­æœªæ£€æµ‹åˆ°é¢éƒ¨landmarks');
                }
                updateVideoStatus(false);
            }
        }

        function updateVideoStatus(faceDetected) {
            const activeStep = document.querySelector('.step-container.active');
            if (activeStep) {
                const statusElement = activeStep.querySelector('.video-status');
                if (statusElement) {
                    statusElement.textContent = faceDetected ? 'æ£€æµ‹åˆ°é¢éƒ¨' : 'æœªæ£€æµ‹åˆ°é¢éƒ¨';
                    statusElement.style.color = faceDetected ? '#4ecdc4' : '#ff6b6b';
                }
            }
        }

        // ç»˜åˆ¶è¦†ç›–å±‚
        function drawOverlay(ctx, landmarks, canvas) {
            ctx.strokeStyle = '#4ecdc4';
            ctx.lineWidth = 2;

            // ç»˜åˆ¶å˜´éƒ¨è½®å»“
            drawLandmarkContour(ctx, LANDMARKS.MOUTH.UPPER_LIP, landmarks, canvas, '#4ecdc4');
            drawLandmarkContour(ctx, LANDMARKS.MOUTH.LOWER_LIP, landmarks, canvas, '#4ecdc4');

            // ç»˜åˆ¶çœ¼éƒ¨è½®å»“
            drawLandmarkContour(ctx, LANDMARKS.LEFT_EYE.OUTLINE, landmarks, canvas, '#45b7d1');
            drawLandmarkContour(ctx, LANDMARKS.RIGHT_EYE.OUTLINE, landmarks, canvas, '#45b7d1');
        }

        function drawLandmarkContour(ctx, indices, landmarks, canvas, color) {
            if (!indices || !landmarks) return;
            
            ctx.strokeStyle = color;
            ctx.beginPath();
            
            let started = false;
            indices.forEach(idx => {
                if (landmarks[idx]) {
                    const point = landmarks[idx];
                    const x = point.x * canvas.width;
                    const y = point.y * canvas.height;
                    
                    if (!started) {
                        ctx.moveTo(x, y);
                        started = true;
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
            });
            
            ctx.closePath();
            ctx.stroke();
        }

        // ç‰¹å¾æå– (ç®€åŒ–ç‰ˆ)
        function extractMetrics(landmarks) {
            if (!landmarks || landmarks.length < 468) return null;

            try {
                const mouth = {
                    leftCorner: landmarks[LANDMARKS.MOUTH.LEFT_CORNER],
                    rightCorner: landmarks[LANDMARKS.MOUTH.RIGHT_CORNER], 
                    top: landmarks[LANDMARKS.MOUTH.TOP],
                    bottom: landmarks[LANDMARKS.MOUTH.BOTTOM]
                };

                const eyes = {
                    leftTop: landmarks[LANDMARKS.LEFT_EYE.TOP],
                    leftBottom: landmarks[LANDMARKS.LEFT_EYE.BOTTOM],
                    rightTop: landmarks[LANDMARKS.RIGHT_EYE.TOP],
                    rightBottom: landmarks[LANDMARKS.RIGHT_EYE.BOTTOM]
                };

                const distance = (p1, p2) => Math.sqrt(Math.pow(p1.x - p2.x, 2) + Math.pow(p1.y - p2.y, 2));

                const mouthWidth = distance(mouth.leftCorner, mouth.rightCorner);
                const mouthHeight = distance(mouth.top, mouth.bottom);
                const mouthRatio = mouthWidth / (mouthHeight + 0.001);
                const mouthOpen = mouthHeight / (mouthWidth + 0.001);

                const leftEAR = distance(eyes.leftTop, eyes.leftBottom) / distance(landmarks[LANDMARKS.LEFT_EYE.LEFT], landmarks[LANDMARKS.LEFT_EYE.RIGHT]);
                const rightEAR = distance(eyes.rightTop, eyes.rightBottom) / distance(landmarks[LANDMARKS.RIGHT_EYE.LEFT], landmarks[LANDMARKS.RIGHT_EYE.RIGHT]);
                const eyeEAR = (leftEAR + rightEAR) / 2;

                return {
                    mouthRatio,
                    mouthOpen,
                    eyeEAR,
                    symMouth: 1 - Math.min(1, Math.abs(mouth.leftCorner.y - mouth.rightCorner.y) * 1000),
                    poseYawProxy: 1 - Math.min(1, Math.abs(landmarks[LANDMARKS.NOSE_TIP].x - 0.5) * 2),
                    illumScore: 0.8 // ç®€åŒ–
                };
            } catch (error) {
                console.error('ç‰¹å¾æå–å¤±è´¥:', error);
                return null;
            }
        }

        // æ ¡å‡†åŠŸèƒ½
        async function setupCalibrationVideo() {
            // æ ¡å‡†é¡µé¢è§†é¢‘è®¾ç½®
            document.getElementById('calibrationInstructions').textContent = 'ä¿æŒæ”¾æ¾çš„ä¸­æ€§è¡¨æƒ…ï¼Œä¸è¦å¾®ç¬‘æˆ–çš±çœ‰';
            
            // å¼ºåˆ¶é‡å¯ç›¸æœºå¹¶ç»‘å®šåˆ°æ ¡å‡†è§†é¢‘å…ƒç´ 
            if (camera) {
                camera.stop();
            }
            
            // ä¸ºæ ¡å‡†æ­¥éª¤é‡æ–°åˆ›å»ºç›¸æœº
            camera = new Camera(document.getElementById('videoElement2'), {
                onFrame: async () => {
                    const video = document.getElementById('videoElement2');
                    if (video && video.videoWidth > 0) {
                        if (isCalibrating && Math.random() < 0.05) {
                            console.log('æ ¡å‡†ä¸­å‘MediaPipeå‘é€å¸§ï¼Œè§†é¢‘å°ºå¯¸:', video.videoWidth, 'x', video.videoHeight);
                        }
                        await faceMesh.send({image: video});
                    } else if (isCalibrating) {
                        console.warn('æ ¡å‡†ä¸­è§†é¢‘å…ƒç´ æœªå‡†å¤‡å¥½:', video ? 'no width' : 'no video');
                    }
                },
                width: 640,
                height: 480
            });
            
            camera.start();
            renderBeautifiedVideo();
            
            console.log('æ ¡å‡†é¡µé¢è®¾ç½®å®Œæˆ');
        }

        function startCalibration() {
            if (isCalibrating) return;
            
            console.log('å¼€å§‹æ ¡å‡†æµç¨‹...');
            console.log('MediaPipeçŠ¶æ€ - faceMesh:', !!faceMesh, 'camera:', !!camera);
            console.log('å½“å‰è§†é¢‘å…ƒç´ çŠ¶æ€:', document.getElementById('videoElement2')?.videoWidth || 'N/A');
            
            isCalibrating = true;
            metricsBuffer = [];
            
            document.getElementById('calibrationBtn').disabled = true;
            updateStatus('æ ¡å‡†ä¸­...', 'running');
            
            // å€’è®¡æ—¶
            let countdown = 3;
            const countdownElement = document.getElementById('countdownOverlay2');
            const progressElement = document.getElementById('calibrationProgress');
            
            countdownElement.textContent = countdown;
            countdownElement.classList.add('show');
            
            const countdownInterval = setInterval(() => {
                countdown--;
                if (countdown > 0) {
                    countdownElement.textContent = countdown;
                } else {
                    countdownElement.textContent = 'å¼€å§‹';
                    clearInterval(countdownInterval);
                    
                    // å¼€å§‹æ ¡å‡†
                    setTimeout(() => {
                        countdownElement.classList.remove('show');
                        startCalibrationCapture();
                    }, 500);
                }
            }, 1000);
        }

        function startCalibrationCapture() {
            const duration = 2000;
            const startTime = performance.now();
            const progressElement = document.getElementById('calibrationProgress');
            
            const updateProgress = () => {
                const elapsed = performance.now() - startTime;
                const progress = Math.min(100, (elapsed / duration) * 100);
                progressElement.style.width = `${progress}%`;
                
                if (elapsed < duration) {
                    requestAnimationFrame(updateProgress);
                } else {
                    finishCalibration();
                }
            };
            
            updateProgress();
        }

        function finishCalibration() {
            isCalibrating = false;
            
            console.log(`æ ¡å‡†ç»“æŸï¼Œæ”¶é›†åˆ° ${metricsBuffer.length} ä¸ªæ•°æ®ç‚¹`);
            
            if (metricsBuffer.length > 0) {
                baseline = calculateBaseline(metricsBuffer);
                console.log('è®¡ç®—çš„åŸºçº¿æ•°æ®:', baseline);
                updateStatus('æ ¡å‡†å®Œæˆ', 'ready');
                
                // æ˜¾ç¤ºæˆåŠŸå¹¶è‡ªåŠ¨è¿›å…¥ä¸‹ä¸€æ­¥
                document.getElementById('calibrationInstructions').innerHTML = 
                    'âœ… æ ¡å‡†æˆåŠŸï¼å»ºç«‹äº†æ‚¨çš„ä¸ªäººé¢éƒ¨åŸºçº¿<br>ç°åœ¨å¯ä»¥å¼€å§‹è¡¨æƒ…è®­ç»ƒäº†';
                
                setTimeout(() => {
                    nextStep();
                }, 2000);
                
            } else {
                console.error('æ ¡å‡†å¤±è´¥ï¼šæœªæ”¶é›†åˆ°é¢éƒ¨æ•°æ®');
                updateStatus('æ ¡å‡†å¤±è´¥', 'error');
                document.getElementById('calibrationBtn').disabled = false;
                document.getElementById('calibrationInstructions').textContent = 'æœªæ£€æµ‹åˆ°é¢éƒ¨ï¼Œè¯·é‡è¯•æ ¡å‡†';
            }
        }

        function calculateBaseline(buffer) {
            const metrics = buffer.map(item => item.metrics).filter(m => m !== null);
            if (metrics.length === 0) return null;
            
            const average = arr => arr.reduce((sum, val) => sum + val, 0) / arr.length;
            
            return {
                mouthRatio: average(metrics.map(m => m.mouthRatio)),
                eyeEAR: average(metrics.map(m => m.eyeEAR)),
                mouthOpen: average(metrics.map(m => m.mouthOpen))
            };
        }

        // è®­ç»ƒåŠŸèƒ½
        async function setupTrainingVideo() {
            // è®­ç»ƒé¡µé¢è§†é¢‘è®¾ç½® - ä¸ºè®­ç»ƒæ­¥éª¤é‡æ–°åˆ›å»ºç›¸æœº
            if (camera) {
                camera.stop();
            }
            
            // ä¸ºè®­ç»ƒæ­¥éª¤é‡æ–°åˆ›å»ºç›¸æœº
            camera = new Camera(document.getElementById('videoElement3'), {
                onFrame: async () => {
                    const video = document.getElementById('videoElement3');
                    if (video && video.videoWidth > 0) {
                        await faceMesh.send({image: video});
                    }
                },
                width: 640,
                height: 480
            });
            
            camera.start();
            loadCurrentExpression();
        }

        function loadCurrentExpression() {
            const commandId = trainingSequence[currentExpressionIndex];
            const command = TRAINING_COMMANDS[commandId];
            
            if (!command) {
                // è®­ç»ƒå®Œæˆï¼Œæ˜¾ç¤ºç»“æœ
                showFinalResults();
                return;
            }
            
            document.getElementById('expressionDemo').textContent = command.emoji;
            document.getElementById('expressionText').textContent = command.text.replace('è¯·åš', '').replace('å¹¶ä¿æŒä¸¤ç§’', '').replace('å¹¶ä¿æŒä¸€ç§’åŠ', '');
            document.getElementById('expressionTips').textContent = command.tips;
            document.getElementById('trainingSubtitle').textContent = `è¡¨æƒ… ${currentExpressionIndex + 1}/${trainingSequence.length}: ${command.text.replace('è¯·åš', '').replace('å¹¶ä¿æŒä¸¤ç§’', '').replace('å¹¶ä¿æŒä¸€ç§’åŠ', '')}`;
            
            // é‡ç½®æŒ‰é’®çŠ¶æ€
            document.getElementById('startTrainingBtn').disabled = false;
            document.getElementById('startTrainingBtn').textContent = 'å¼€å§‹';
        }

        function startExpression() {
            if (isRunning) return;
            
            const commandId = trainingSequence[currentExpressionIndex];
            const command = TRAINING_COMMANDS[commandId];
            
            isRunning = true;
            metricsBuffer = [];
            
            document.getElementById('startTrainingBtn').disabled = true;
            document.getElementById('skipBtn').disabled = true;
            updateStatus('è®­ç»ƒä¸­...', 'running');
            
            // TTS æ’­æŠ¥
            if (command.tts && 'speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(command.text);
                speechSynthesis.speak(utterance);
            }
            
            // å€’è®¡æ—¶
            let countdown = 3;
            const countdownElement = document.getElementById('countdownOverlay3');
            countdownElement.textContent = countdown;
            countdownElement.classList.add('show');
            
            countdownTimer = setInterval(() => {
                countdown--;
                if (countdown > 0) {
                    countdownElement.textContent = countdown;
                } else {
                    countdownElement.textContent = 'å¼€å§‹!';
                    clearInterval(countdownTimer);
                    
                    setTimeout(() => {
                        countdownElement.classList.remove('show');
                        startExpressionCapture(command);
                    }, 500);
                }
            }, 1000);
        }

        function startExpressionCapture(command) {
            const duration = command.duration;
            const startTime = performance.now();
            const progressElement = document.getElementById('trainingProgress');
            
            currentSession = {
                mode: selectedMode,
                command: command,
                startTime: startTime
            };
            
            const updateProgress = () => {
                const elapsed = performance.now() - startTime;
                const progress = Math.min(100, (elapsed / duration) * 100);
                progressElement.style.width = `${progress}%`;
                
                if (elapsed < duration) {
                    requestAnimationFrame(updateProgress);
                } else {
                    finishExpression();
                }
            };
            
            updateProgress();
        }

        function finishExpression() {
            isRunning = false;
            currentSession.endTime = performance.now();
            
            // åˆ†æè¿™æ¬¡è¡¨æƒ…çš„ç»“æœ
            if (metricsBuffer.length > 0) {
                const result = analyzeExpression();
                showExpressionResult(result);
            }
            
            // å‡†å¤‡ä¸‹ä¸€ä¸ªè¡¨æƒ…æˆ–å®Œæˆè®­ç»ƒ
            setTimeout(() => {
                currentExpressionIndex++;
                if (currentExpressionIndex < trainingSequence.length) {
                    loadCurrentExpression();
                } else {
                    showFinalResults();
                }
            }, 3000);
        }

        function nextExpression() {
            if (countdownTimer) clearInterval(countdownTimer);
            if (trainingTimer) clearInterval(trainingTimer);
            
            document.getElementById('countdownOverlay3').classList.remove('show');
            document.getElementById('trainingProgress').style.width = '0%';
            
            isRunning = false;
            currentExpressionIndex++;
            
            if (currentExpressionIndex < trainingSequence.length) {
                loadCurrentExpression();
            } else {
                showFinalResults();
            }
        }

        function analyzeExpression() {
            const validMetrics = metricsBuffer.map(item => item.metrics).filter(m => m !== null);
            if (validMetrics.length === 0) return null;
            
            const average = arr => arr.reduce((sum, val) => sum + val, 0) / arr.length;
            
            const avgMetrics = {
                mouthRatio: average(validMetrics.map(m => m.mouthRatio)),
                eyeEAR: average(validMetrics.map(m => m.eyeEAR)),
                mouthOpen: average(validMetrics.map(m => m.mouthOpen)),
                symMouth: average(validMetrics.map(m => m.symMouth))
            };
            
            // ç®€åŒ–è¯„åˆ†
            const scores = calculateSimpleScores(avgMetrics, currentSession.command.target);
            
            return {
                scores: scores,
                metrics: avgMetrics
            };
        }

        function calculateSimpleScores(metrics, target) {
            let match = 50;
            
            // æ ¹æ®è¡¨æƒ…ç±»å‹è®¡ç®—åŒ¹é…åº¦
            switch (target) {
                case 'smile':
                    const smileIntensity = baseline ? 
                        (metrics.mouthRatio - baseline.mouthRatio) : 
                        (metrics.mouthRatio - 2.5);
                    match = Math.max(0, Math.min(100, smileIntensity * 30 + 60));
                    break;
                    
                case 'surprised':
                    match = Math.max(0, Math.min(100, metrics.mouthOpen * 150 + 30));
                    break;
                    
                case 'sad':
                case 'angry':
                    match = Math.max(30, Math.min(90, 70 + Math.random() * 20));
                    break;
                    
                default:
                    match = Math.max(40, Math.min(90, 60 + Math.random() * 30));
            }
            
            return {
                clarity: Math.round(match + Math.random() * 10 - 5),
                consistency: Math.round(metrics.symMouth * 100),
                intensity: Math.round(Math.min(100, match * (selectedMode === 'stage' ? 1.1 : 0.9))),
                truth: Math.round(Math.max(60, match - 5 + Math.random() * 10))
            };
        }

        function showExpressionResult(result) {
            if (!result) return;
            
            const avgScore = (result.scores.clarity + result.scores.consistency + result.scores.intensity + result.scores.truth) / 4;
            
            // æ›´æ–°è¡¨æƒ…æŒ‡å¯¼åŒºåŸŸæ˜¾ç¤ºç»“æœ
            document.getElementById('expressionDemo').textContent = avgScore > 80 ? 'ğŸ‰' : avgScore > 60 ? 'ğŸ‘' : 'ğŸ’ª';
            document.getElementById('expressionText').textContent = avgScore > 80 ? 'ä¼˜ç§€!' : avgScore > 60 ? 'è‰¯å¥½!' : 'ç»§ç»­åŠªåŠ›!';
            document.getElementById('expressionTips').innerHTML = `
                æ¸…æ™°åº¦: ${result.scores.clarity} | ä¸€è‡´æ€§: ${result.scores.consistency}<br>
                å¼ºåº¦: ${result.scores.intensity} | çœŸå®æ€§: ${result.scores.truth}
            `;
            
            // å¦‚æœè¡¨ç°ä¼˜ç§€ï¼Œæ’­æ”¾åº†ç¥åŠ¨ç”»
            if (avgScore > 85) {
                showCelebration();
            }
            
            updateStatus('è¡¨æƒ…å®Œæˆ', 'ready');
            document.getElementById('skipBtn').disabled = false;
        }

        function showCelebration() {
            const container = document.getElementById('celebrationContainer');
            
            // åˆ›å»ºå½©å¸¦æ•ˆæœ
            for (let i = 0; i < 20; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.background = ['#4ecdc4', '#45b7d1', '#96ceb4', '#ff6b6b'][Math.floor(Math.random() * 4)];
                confetti.style.animationDelay = Math.random() * 2 + 's';
                container.appendChild(confetti);
                
                setTimeout(() => confetti.remove(), 3000);
            }
        }

        function showFinalResults() {
            // åˆ‡æ¢åˆ°ç»“æœé¡µé¢
            document.getElementById('trainingStep').classList.remove('active');
            document.getElementById('resultsStep').classList.add('active');
            
            // æ›´æ–°ç»“æœæ•°æ® (æ¨¡æ‹Ÿæ•°æ®)
            const results = {
                clarity: 78 + Math.floor(Math.random() * 20),
                consistency: 82 + Math.floor(Math.random() * 15),
                intensity: selectedMode === 'stage' ? 88 + Math.floor(Math.random() * 12) : 72 + Math.floor(Math.random() * 18),
                truth: 85 + Math.floor(Math.random() * 15)
            };
            
            updateResultsDisplay(results);
            generateFeedback(results);
            updateStatus('è®­ç»ƒå®Œæˆ', 'ready');
        }

        function updateResultsDisplay(results) {
            // æ›´æ–°åˆ†æ•°æ˜¾ç¤º
            document.getElementById('clarityValue').textContent = results.clarity;
            document.getElementById('consistencyValue').textContent = results.consistency;
            document.getElementById('intensityValue').textContent = results.intensity;
            document.getElementById('truthValue').textContent = results.truth;
            
            // æ›´æ–°åˆ†æ•°å¡ç‰‡æ ·å¼
            updateScoreCard('clarityCard', results.clarity);
            updateScoreCard('consistencyCard', results.consistency);
            updateScoreCard('intensityCard', results.intensity);
            updateScoreCard('truthCard', results.truth);
            
            // æ›´æ–°æ¨¡å¼æ˜¾ç¤º
            document.getElementById('resultSubtitle').textContent = 
                `æ‚¨åœ¨${selectedMode === 'film' ? 'å½±è§†é•œå¤´' : 'èˆå°è¡¨æ¼”'}æ¨¡å¼ä¸‹çš„è¡¨ç°`;
        }

        function updateScoreCard(cardId, score) {
            const card = document.getElementById(cardId);
            card.classList.remove('excellent', 'good', 'needs-work');
            
            if (score >= 85) {
                card.classList.add('excellent');
            } else if (score >= 70) {
                card.classList.add('good');
            } else {
                card.classList.add('needs-work');
            }
        }

        function generateFeedback(results) {
            const feedback = [];
            const avgScore = (results.clarity + results.consistency + results.intensity + results.truth) / 4;
            
            if (avgScore >= 85) {
                feedback.push({
                    icon: 'ğŸ‰',
                    text: 'å‡ºè‰²çš„è¡¨ç°ï¼æ‚¨çš„è¡¨æƒ…æ§åˆ¶èƒ½åŠ›å·²ç»è¾¾åˆ°ä¸“ä¸šæ°´å‡†ã€‚'
                });
            } else if (avgScore >= 75) {
                feedback.push({
                    icon: 'ğŸ‘',
                    text: 'è¡¨ç°è‰¯å¥½ï¼ç»§ç»­ç»ƒä¹ ä¼šæœ‰æ›´å¤§çš„è¿›æ­¥ç©ºé—´ã€‚'
                });
            } else {
                feedback.push({
                    icon: 'ğŸ’ª',
                    text: 'è¿˜æœ‰æå‡ç©ºé—´ï¼Œå»ºè®®å¤šç»ƒä¹ åŸºç¡€è¡¨æƒ…ã€‚'
                });
            }
            
            if (results.intensity < 70 && selectedMode === 'stage') {
                feedback.push({
                    icon: 'ğŸ­',
                    text: 'èˆå°è¡¨æ¼”éœ€è¦æ›´å¤§çš„è¡¨æƒ…å¹…åº¦ï¼Œè®©åæ’è§‚ä¼—ä¹Ÿèƒ½çœ‹æ¸…ã€‚'
                });
            }
            
            if (results.intensity > 85 && selectedMode === 'film') {
                feedback.push({
                    icon: 'ğŸ¬',
                    text: 'å½±è§†è¡¨æ¼”ä¸­è¿‡åº¦å¤¸å¼ å¯èƒ½æ˜¾å¾—ä¸è‡ªç„¶ï¼Œé€‚å½“æ”¶æ•›ä¼šæ›´å¥½ã€‚'
                });
            }
            
            if (results.truth < 75) {
                feedback.push({
                    icon: 'ğŸ’«',
                    text: 'è¡¨æƒ…çš„çœŸå®æ„Ÿæœ‰å¾…æé«˜ï¼Œè¯•ç€ä»å†…å¿ƒæ„Ÿå—æƒ…ç»ªã€‚'
                });
            }
            
            // æ˜¾ç¤ºåé¦ˆ
            const container = document.getElementById('feedbackContainer');
            container.innerHTML = '';
            
            feedback.forEach(item => {
                const feedbackElement = document.createElement('div');
                feedbackElement.className = 'feedback-item';
                feedbackElement.innerHTML = `
                    <div class="feedback-icon">${item.icon}</div>
                    <div class="feedback-text">${item.text}</div>
                `;
                container.appendChild(feedbackElement);
            });
        }

        // é‡æ–°å¼€å§‹è®­ç»ƒ
        function restartTraining() {
            currentExpressionIndex = 0;
            currentStep = 0;
            selectedMode = null;
            baseline = null;
            
            // é‡ç½®UI
            document.getElementById('resultsStep').classList.remove('active');
            document.getElementById('welcomeStep').classList.add('active');
            
            // é‡ç½®æ¨¡å¼é€‰æ‹©
            document.querySelectorAll('.mode-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.getElementById('modeNextBtn').disabled = true;
            
            updateStatus('é‡æ–°å¼€å§‹', 'ready');
        }

        // ç»§ç»­è®­ç»ƒ
        function continueTraining() {
            currentExpressionIndex = 0;
            
            // å›åˆ°è®­ç»ƒæ­¥éª¤
            document.getElementById('resultsStep').classList.remove('active');
            document.getElementById('trainingStep').classList.add('active');
            currentStep = 4;
            
            loadCurrentExpression();
            updateStatus('ç»§ç»­è®­ç»ƒ', 'ready');
        }

        // ç¾é¢œåŠŸèƒ½å‡½æ•°
        function toggleBeauty() {
            beautyEnabled = !beautyEnabled;
            
            // åªæ›´æ–°ç¾é¢œå¼€å…³çš„çŠ¶æ€ï¼Œä¸å½±å“é•œåƒå¼€å…³
            const beautySwitch = document.getElementById('beautySwitch');
            if (beautySwitch) {
                if (beautyEnabled) {
                    beautySwitch.classList.add('active');
                } else {
                    beautySwitch.classList.remove('active');
                }
            }
            
            // æ˜¾ç¤º/éšè—æ»‘å—
            document.querySelectorAll('.beauty-slider').forEach(slider => {
                if (beautyEnabled) {
                    slider.classList.add('active');
                } else {
                    slider.classList.remove('active');
                }
            });
            
            updateBeauty();
        }
        
        
        function updateBeauty() {
            if (!beautyEnabled) return;
            
            // è·å–å½“å‰æ¿€æ´»æ­¥éª¤çš„æ»‘å—å€¼
            const activeStep = document.querySelector('.step-container.active');
            if (activeStep) {
                const smoothRange = activeStep.querySelector('[id*="smoothRange"]');
                const brightnessRange = activeStep.querySelector('[id*="brightnessRange"]');
                const contrastRange = activeStep.querySelector('[id*="contrastRange"]');
                
                if (smoothRange) beautySettings.smooth = parseInt(smoothRange.value);
                if (brightnessRange) beautySettings.brightness = parseInt(brightnessRange.value);
                if (contrastRange) beautySettings.contrast = parseInt(contrastRange.value);
            }
        }
        
        function applyBeautyFilter(sourceCanvas, targetCanvas) {
            if (!beautyEnabled) {
                // å¦‚æœç¾é¢œå…³é—­ï¼Œç›´æ¥å¤åˆ¶åŸå›¾
                const sourceCtx = sourceCanvas.getContext('2d');
                const targetCtx = targetCanvas.getContext('2d');
                targetCtx.clearRect(0, 0, targetCanvas.width, targetCanvas.height);
                targetCtx.drawImage(sourceCanvas, 0, 0);
                return;
            }
            
            const sourceCtx = sourceCanvas.getContext('2d');
            const targetCtx = targetCanvas.getContext('2d');
            
            // è·å–å›¾åƒæ•°æ®
            const imageData = sourceCtx.getImageData(0, 0, sourceCanvas.width, sourceCanvas.height);
            const data = imageData.data;
            
            // åº”ç”¨ç¾é¢œæ•ˆæœ
            for (let i = 0; i < data.length; i += 4) {
                let r = data[i];
                let g = data[i + 1];
                let b = data[i + 2];
                
                // ç£¨çš®æ•ˆæœ (ç®€åŒ–ç‰ˆé«˜æ–¯æ¨¡ç³Š)
                if (beautySettings.smooth > 0) {
                    const smoothFactor = beautySettings.smooth / 100 * 0.3;
                    r = r + (128 - r) * smoothFactor;
                    g = g + (128 - g) * smoothFactor;
                    b = b + (128 - b) * smoothFactor;
                }
                
                // äº®åº¦è°ƒæ•´
                const brightnessFactor = beautySettings.brightness / 50;
                r = Math.max(0, Math.min(255, r + brightnessFactor * 30));
                g = Math.max(0, Math.min(255, g + brightnessFactor * 30));
                b = Math.max(0, Math.min(255, b + brightnessFactor * 30));
                
                // å¯¹æ¯”åº¦è°ƒæ•´
                const contrastFactor = (beautySettings.contrast + 50) / 50;
                r = Math.max(0, Math.min(255, (r - 128) * contrastFactor + 128));
                g = Math.max(0, Math.min(255, (g - 128) * contrastFactor + 128));
                b = Math.max(0, Math.min(255, (b - 128) * contrastFactor + 128));
                
                data[i] = r;
                data[i + 1] = g;
                data[i + 2] = b;
            }
            
            // å°†å¤„ç†åçš„æ•°æ®ç»˜åˆ¶åˆ°ç›®æ ‡ç”»å¸ƒ
            targetCtx.putImageData(imageData, 0, 0);
        }
        
        function renderBeautifiedVideo() {
            const activeStep = document.querySelector('.step-container.active');
            if (!activeStep) return;
            
            // è°ƒè¯•ä¿¡æ¯
            if (isCalibrating && Math.random() < 0.01) { // 1%æ¦‚ç‡æ‰“å°ï¼Œé¿å…æ—¥å¿—è¿‡å¤š
                console.log('renderBeautifiedVideoè¿è¡Œä¸­ï¼ŒactiveStep:', activeStep.id);
            }
            
            const video = activeStep.querySelector('video');
            const beautifiedCanvas = activeStep.querySelector('[id*="beautifiedCanvas"]');
            
            if (!video || !beautifiedCanvas || video.videoWidth === 0) {
                requestAnimationFrame(renderBeautifiedVideo);
                return;
            }
            
            // è®¾ç½®ç”»å¸ƒå°ºå¯¸
            if (beautifiedCanvas.width !== video.videoWidth) {
                beautifiedCanvas.width = video.videoWidth;
                beautifiedCanvas.height = video.videoHeight;
            }
            
            const ctx = beautifiedCanvas.getContext('2d');
            
            if (beautyEnabled) {
                // å…ˆç»˜åˆ¶è§†é¢‘å¸§åˆ°ä¸´æ—¶ç”»å¸ƒ
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = video.videoWidth;
                tempCanvas.height = video.videoHeight;
                const tempCtx = tempCanvas.getContext('2d');
                tempCtx.drawImage(video, 0, 0);
                
                // åº”ç”¨ç¾é¢œæ»¤é•œ
                applyBeautyFilter(tempCanvas, beautifiedCanvas);
            } else {
                // ç›´æ¥ç»˜åˆ¶åŸå§‹è§†é¢‘
                ctx.drawImage(video, 0, 0);
            }
            
            // ç»§ç»­ä¸‹ä¸€å¸§
            requestAnimationFrame(renderBeautifiedVideo);
        }

        // === Recording state ===
        let recorder, recordedChunks = [];
        let mixedStream;

        // å¦‚æœéœ€è¦é‡‡é›†éº¦å…‹é£ï¼Œè¯·å°†æ­¤é¡¹è®¾ä¸º trueï¼ˆé»˜è®¤ false ä»…å½•ç”»é¢ï¼‰
        const ENABLE_MIC = false;

        // ç”¨ç¾é¢œåçš„ç”»å¸ƒä½œä¸ºè§†é¢‘æºï¼ˆä¸é¡µé¢ä¸€è‡´ï¼š#beautifiedCanvas3ï¼‰
        function getCanvasStream() {
            const canvas = document.getElementById('beautifiedCanvas3');
            // 30fps å¯æŒ‰éœ€è°ƒæ•´
            return canvas.captureStream(30);
        }

        async function startRecording() {
            // ç”»é¢æµ
            const canvasStream = getCanvasStream();

            // å¯é€‰ï¼šåˆå¹¶éº¦å…‹é£éŸ³é¢‘ï¼ˆç§»åŠ¨ç«¯éœ€è¦ HTTPS+æ‰‹åŠ¿è§¦å‘ï¼‰
            if (ENABLE_MIC) {
                const mic = await navigator.mediaDevices.getUserMedia({ audio: true });
                mixedStream = new MediaStream([
                    ...canvasStream.getVideoTracks(),
                    ...mic.getAudioTracks()
                ]);
            } else {
                mixedStream = canvasStream;
            }

            recordedChunks = [];
            recorder = new MediaRecorder(mixedStream, { mimeType: 'video/webm; codecs=vp9,opus' });
            recorder.ondataavailable = e => { if (e.data.size > 0) recordedChunks.push(e.data); };
            recorder.onstop = async () => {
                const blob = new Blob(recordedChunks, { type: 'video/webm' });
                // å­˜åˆ° sessionStorageï¼Œä¾›ä¸‹ä¸€é¡µè¯»å–
                const b64 = await blobToBase64(blob);
                sessionStorage.setItem('lastTrainingVideo_b64', b64);
                // è·³è½¬åˆ°é¢„è§ˆ+åˆ†äº«é¡µ
                window.location.href = 'video-share.html';
            };
            recorder.start();
        }

        function stopRecordingAndGo() {
            if (recorder && recorder.state !== 'inactive') {
                recorder.stop();
            } else {
                // å…œåº•ï¼šæ²¡æœ‰å½•åˆ°å°±æç¤º
                alert('No video recorded â€” please try training again.');
            }
        }

        function blobToBase64(blob) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.readAsDataURL(blob); // data:URL(base64)
            });
        }

        // === å°†å½•åˆ¶ä¸"è®­ç»ƒå¼€å§‹/ç»“æŸ"ç»‘å®š ===
        // å½“ç”¨æˆ·ç‚¹å‡»"Start"å¼€å§‹æŸä¸ªè¡¨æƒ…è®­ç»ƒæ—¶å¼€å§‹å½•åˆ¶ï¼›å½“è®­ç»ƒåºåˆ—å…¨éƒ¨å®Œæˆè¿›å…¥ results æ—¶åœæ­¢å½•åˆ¶ã€‚
        // å¦‚æœä½ çš„ä»£ç é‡Œå·²æœ‰è®­ç»ƒçŠ¶æ€æœºï¼Œè¯·åœ¨åˆé€‚çš„èµ·æ­¢é’©å­é‡Œè°ƒç”¨ï¼šstartRecording() / stopRecordingAndGo()ã€‚
        // æš‚æ—¶æä¾›æœ€å°å®ç°ï¼šå½“ç‚¹å‡»å¼€å§‹è®­ç»ƒæŒ‰é’®æ—¶å¼€å¯ï¼›å½“æ˜¾ç¤ºç»“æœé¡µï¼ˆ#resultsStepï¼‰æ—¶åœæ­¢ã€‚
        (function wireRecording() {
            // å¼€å§‹æŒ‰é’®ï¼ˆè‹±æ–‡é¡µ id='startTrainingBtn'ï¼›ä¸­æ–‡é¡µä¸€è‡´æˆ–åä¸º"å¼€å§‹"æŒ‰é’®ï¼‰ï¼š
            const startBtn = document.getElementById('startTrainingBtn');
            if (startBtn) {
                startBtn.addEventListener('click', () => {
                    // é˜²å¤šæ¬¡å¯åŠ¨
                    if (!recorder || recorder.state === 'inactive') {
                        startRecording();
                    }
                }, { once: false });
            }

            // æ³¨é‡Šæ‰è‡ªåŠ¨è·³è½¬ï¼Œè®©ç”¨æˆ·è‡ªå·±å†³å®šæ˜¯å¦ç”Ÿæˆè§†é¢‘
            // const resultsStep = document.getElementById('resultsStep');
            // const observer = new MutationObserver(() => {
            //     if (resultsStep.classList.contains('active')) {
            //         stopRecordingAndGo();
            //     }
            // });
            // if (resultsStep) observer.observe(resultsStep, { attributes: true, attributeFilter: ['class'] });

            // åˆ†äº«è§†é¢‘æŒ‰é’®äº‹ä»¶
            const shareBtn = document.getElementById('makeShareVideoBtn');
            if (shareBtn) {
                shareBtn.addEventListener('click', () => {
                    // è‹¥å½•åˆ¶å·²ç»“æŸä¼šç›´æ¥è·³è½¬ï¼›è‹¥ä»åœ¨å½•åˆ¶åˆ™å…ˆåœæ­¢å†è·³è½¬
                    stopRecordingAndGo();
                });
            }
        })();

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            updateStatus('æ¬¢è¿ä½¿ç”¨è¡¨æƒ…è®­ç»ƒæ•™ç»ƒ', 'ready');
            // å¯åŠ¨ç¾é¢œæ¸²æŸ“å¾ªç¯
            renderBeautifiedVideo();
        });
    </script>
</body>
</html>