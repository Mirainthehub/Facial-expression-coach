<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>表情训练教练 - 专业版</title>
    <!--
    本地运行说明：
    1. 摄像头需要 HTTPS 或 localhost，使用以下命令本地起服务：
       python -m http.server 8000
       然后访问 http://localhost:8000
    
    2. 或使用 Python 3:
       python3 -m http.server 8000
       
    3. 所有计算在本地完成，不上传任何图像视频数据
    -->
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #ffffff;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* 步骤容器样式 */
        .step-container {
            display: none;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border-radius: 24px;
            padding: 40px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            text-align: center;
        }
        
        .step-container.active {
            display: block;
            animation: slideInUp 0.6s ease-out;
        }
        
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* 步骤标题 */
        .step-title {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #4ecdc4, #45b7d1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .step-subtitle {
            font-size: 18px;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 30px;
        }
        
        /* 步骤进度指示器 */
        .step-progress {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 40px;
            gap: 20px;
        }
        
        .progress-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }
        
        .progress-dot.active {
            background: #4ecdc4;
            transform: scale(1.5);
            box-shadow: 0 0 20px rgba(78, 205, 196, 0.6);
        }
        
        .progress-dot.completed {
            background: #96ceb4;
        }
        
        /* 欢迎屏幕 */
        .welcome-content {
            max-width: 600px;
            margin: 0 auto;
        }
        
        .welcome-icon {
            font-size: 80px;
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .feature-list {
            text-align: left;
            margin: 30px 0;
            background: rgba(0, 0, 0, 0.2);
            padding: 25px;
            border-radius: 16px;
        }
        
        .feature-item {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            font-size: 16px;
        }
        
        .feature-icon {
            font-size: 24px;
            margin-right: 15px;
            width: 40px;
        }
        
        /* 设置屏幕 */
        .mode-selection {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin: 30px 0;
        }
        
        .mode-card {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .mode-card:hover {
            transform: translateY(-5px);
            border-color: #4ecdc4;
            box-shadow: 0 10px 30px rgba(78, 205, 196, 0.3);
        }
        
        .mode-card.selected {
            border-color: #4ecdc4;
            background: rgba(78, 205, 196, 0.2);
        }
        
        .mode-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        .mode-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .mode-description {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            line-height: 1.5;
        }
        
        /* 校准屏幕 */
        .calibration-content {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .video-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin: 0 auto 30px;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }
        
        .beauty-controls {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            z-index: 20;
        }
        
        .beauty-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .beauty-switch {
            position: relative;
            width: 50px;
            height: 26px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .beauty-switch.active {
            background: #4ecdc4;
        }
        
        .beauty-switch-knob {
            position: absolute;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: all 0.3s ease;
        }
        
        .beauty-switch.active .beauty-switch-knob {
            transform: translateX(24px);
        }
        
        .beauty-label {
            font-size: 12px;
            color: #fff;
            font-weight: 500;
        }
        
        .beauty-slider {
            display: none;
            margin-bottom: 8px;
        }
        
        .beauty-slider.active {
            display: block;
        }
        
        .beauty-slider input {
            width: 100px;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            outline: none;
            -webkit-appearance: none;
        }
        
        .beauty-slider input::-webkit-slider-thumb {
            width: 14px;
            height: 14px;
            background: #4ecdc4;
            border-radius: 50%;
            cursor: pointer;
            -webkit-appearance: none;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }
        
        .beauty-slider-label {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 4px;
        }
        
        .video-wrapper {
            position: relative;
            width: 100%;
            height: 400px;
            background: #000;
        }
        
        #videoElement,
        #videoElement2,
        #videoElement3 {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }
        
        #videoElement,
        #videoElement2,
        #videoElement3,
        #beautifiedCanvas,
        #beautifiedCanvas2,
        #beautifiedCanvas3 {
            transform: scaleX(-1);
        }
        
        #beautifiedCanvas,
        #beautifiedCanvas2,
        #beautifiedCanvas3 {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 2;
            pointer-events: none;
        }
        
        #overlayCanvas,
        #overlayCanvas2,
        #overlayCanvas3 {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 3;
        }
        
        .video-status {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(0, 0, 0, 0.8);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .countdown-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 120px;
            font-weight: bold;
            color: #4ecdc4;
            text-shadow: 2px 2px 10px rgba(0, 0, 0, 0.8);
            z-index: 10;
            display: none;
        }
        
        .countdown-overlay.show {
            display: block;
            animation: countdownPulse 1s ease-out;
        }
        
        @keyframes countdownPulse {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        
        /* 训练屏幕 */
        .training-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 40px;
            align-items: start;
        }
        
        @media (max-width: 1200px) {
            .training-content {
                grid-template-columns: 1fr;
            }
        }
        
        .expression-guide {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
        }
        
        .expression-demo {
            font-size: 80px;
            margin-bottom: 20px;
            animation: expressionDemo 2s ease-in-out infinite;
        }
        
        @keyframes expressionDemo {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .expression-text {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #4ecdc4;
        }
        
        .expression-tips {
            font-size: 16px;
            line-height: 1.6;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 30px;
        }
        
        .training-progress {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            height: 8px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .training-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ecdc4, #45b7d1);
            width: 0%;
            transition: width 0.1s ease;
        }
        
        /* 结果屏幕 */
        .results-content {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .score-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .score-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 25px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .score-card.excellent {
            border-color: #4ecdc4;
            background: rgba(78, 205, 196, 0.2);
        }
        
        .score-card.good {
            border-color: #45b7d1;
            background: rgba(69, 183, 209, 0.2);
        }
        
        .score-card.needs-work {
            border-color: #ff6b6b;
            background: rgba(255, 107, 107, 0.2);
        }
        
        .score-icon {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .score-label {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 8px;
        }
        
        .score-value {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .score-change {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 12px;
            background: rgba(0, 0, 0, 0.3);
        }
        
        .feedback-section {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
        }
        
        .feedback-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #4ecdc4;
        }
        
        .feedback-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
        }
        
        .feedback-icon {
            font-size: 20px;
            margin-right: 15px;
            margin-top: 2px;
        }
        
        .feedback-text {
            flex: 1;
            line-height: 1.5;
        }
        
        /* 按钮样式 */
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #4ecdc4, #45b7d1);
            color: #ffffff;
            min-width: 200px;
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: #ffffff;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .btn-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }
        
        /* 生成视频按钮特殊样式 */
        #makeShareVideoBtn {
            background: linear-gradient(45deg, #ff6b6b, #ff8e8e);
            font-size: 18px;
            padding: 18px 35px;
            box-shadow: 0 4px 20px rgba(255, 107, 107, 0.3);
        }
        
        #makeShareVideoBtn:hover {
            background: linear-gradient(45deg, #ff5252, #ff7979);
            box-shadow: 0 6px 25px rgba(255, 107, 107, 0.4);
        }
        
        /* 动画和效果 */
        .celebration {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }
        
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #4ecdc4;
            animation: confetti 3s ease-out forwards;
        }
        
        @keyframes confetti {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }
        
        /* 状态指示器 */
        .status-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 500;
            z-index: 100;
            backdrop-filter: blur(10px);
        }
        
        .status-ready {
            background: rgba(150, 206, 180, 0.9);
            color: #ffffff;
        }
        
        .status-running {
            background: rgba(78, 205, 196, 0.9);
            color: #ffffff;
            animation: pulse 1.5s infinite;
        }
        
        .status-error {
            background: rgba(255, 107, 107, 0.9);
            color: #ffffff;
        }
        
        /* 语言切换 */
        .language-switcher {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 100;
        }
        
        .lang-link {
            display: inline-block;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            color: #ffffff;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        
        .lang-link:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .app-container {
                padding: 15px;
            }
            
            .step-container {
                padding: 25px;
            }
            
            .step-title {
                font-size: 24px;
            }
            
            .mode-selection {
                grid-template-columns: 1fr;
            }
            
            .training-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .score-display {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- 语言切换 -->
        <div class="language-switcher">
            <a href="./index-en.html" class="lang-link">🇺🇸 English</a>
        </div>
        
        <!-- 状态指示器 -->
        <div class="status-indicator" id="statusIndicator">初始化中...</div>
        
        <!-- 步骤1: 欢迎屏幕 -->
        <div class="step-container active" id="welcomeStep">
            <div class="step-progress">
                <div class="progress-dot active"></div>
                <div class="progress-dot"></div>
                <div class="progress-dot"></div>
                <div class="progress-dot"></div>
                <div class="progress-dot"></div>
            </div>
            
            <div class="welcome-content">
                <div class="welcome-icon">🎭</div>
                <h1 class="step-title">表情训练教练</h1>
                <p class="step-subtitle">AI驱动的专业表演训练系统</p>
                
                <div class="feature-list">
                    <div class="feature-item">
                        <span class="feature-icon">🎬</span>
                        <span>影视镜头 vs 舞台表演模式</span>
                    </div>
                    <div class="feature-item">
                        <span class="feature-icon">📊</span>
                        <span>四维专业评分系统</span>
                    </div>
                    <div class="feature-item">
                        <span class="feature-icon">🎯</span>
                        <span>个人化校准与反馈</span>
                    </div>
                    <div class="feature-item">
                        <span class="feature-icon">✨</span>
                        <span>智能美颜，提升自信</span>
                    </div>
                    <div class="feature-item">
                        <span class="feature-icon">🔒</span>
                        <span>本地计算，保护隐私</span>
                    </div>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="nextStep()">开始训练</button>
                </div>
            </div>
        </div>
        
        <!-- 步骤2: 模式选择 -->
        <div class="step-container" id="modeStep">
            <div class="step-progress">
                <div class="progress-dot completed"></div>
                <div class="progress-dot active"></div>
                <div class="progress-dot"></div>
                <div class="progress-dot"></div>
                <div class="progress-dot"></div>
            </div>
            
            <h2 class="step-title">选择表演模式</h2>
            <p class="step-subtitle">不同模式将影响评分标准和训练重点</p>
            
            <div class="mode-selection">
                <div class="mode-card" onclick="selectMode('film')">
                    <div class="mode-icon">🎬</div>
                    <div class="mode-title">影视镜头</div>
                    <div class="mode-description">
                        适合近距离镜头拍摄，注重表情的细腻度和真实感。过度夸张会被扣分。
                    </div>
                </div>
                
                <div class="mode-card" onclick="selectMode('stage')">
                    <div class="mode-icon">🎭</div>
                    <div class="mode-title">舞台表演</div>
                    <div class="mode-description">
                        适合舞台演出，需要清晰可见的表情幅度，让后排观众也能看清。
                    </div>
                </div>
            </div>
            
            <div class="btn-group">
                <button class="btn btn-secondary" onclick="prevStep()">返回</button>
                <button class="btn btn-primary" id="modeNextBtn" onclick="nextStep()" disabled>下一步</button>
            </div>
        </div>
        
        <!-- 步骤3: 摄像头准备 -->
        <div class="step-container" id="cameraStep">
            <div class="step-progress">
                <div class="progress-dot completed"></div>
                <div class="progress-dot completed"></div>
                <div class="progress-dot active"></div>
                <div class="progress-dot"></div>
                <div class="progress-dot"></div>
            </div>
            
            <h2 class="step-title">摄像头准备</h2>
            <p class="step-subtitle">请允许摄像头访问权限，确保面部清晰可见</p>
            
            <div class="calibration-content">
                <div class="video-container">
                    <div class="video-wrapper">
                        <video id="videoElement" autoplay muted playsinline></video>
                        <canvas id="beautifiedCanvas"></canvas>
                        <canvas id="overlayCanvas"></canvas>
                        <div class="video-status" id="videoStatus">检测中...</div>
                        <div class="countdown-overlay" id="countdownOverlay">3</div>
                        
                        <div class="beauty-controls">
                            <div class="beauty-toggle">
                                <div class="beauty-switch" id="beautySwitch" onclick="toggleBeauty()">
                                    <div class="beauty-switch-knob"></div>
                                </div>
                                <span class="beauty-label">美颜</span>
                            </div>
                            
                            
                            <div class="beauty-slider" id="smoothSlider">
                                <div class="beauty-slider-label">磨皮</div>
                                <input type="range" min="0" max="100" value="50" id="smoothRange" oninput="updateBeauty()">
                            </div>
                            
                            <div class="beauty-slider" id="brightnessSlider">
                                <div class="beauty-slider-label">亮度</div>
                                <input type="range" min="-50" max="50" value="10" id="brightnessRange" oninput="updateBeauty()">
                            </div>
                            
                            <div class="beauty-slider" id="contrastSlider">
                                <div class="beauty-slider-label">对比</div>
                                <input type="range" min="-50" max="50" value="15" id="contrastRange" oninput="updateBeauty()">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="feature-list" style="text-align: center;">
                    <div class="feature-item" style="justify-content: center;">
                        <span class="feature-icon">💡</span>
                        <span>确保光线充足，避免背光</span>
                    </div>
                    <div class="feature-item" style="justify-content: center;">
                        <span class="feature-icon">👤</span>
                        <span>保持正面朝向摄像头</span>
                    </div>
                    <div class="feature-item" style="justify-content: center;">
                        <span class="feature-icon">📏</span>
                        <span>头部占据画面1/3左右</span>
                    </div>
                </div>
            </div>
            
            <div class="btn-group">
                <button class="btn btn-secondary" onclick="prevStep()">返回</button>
                <button class="btn btn-primary" id="cameraNextBtn" onclick="nextStep()" disabled>开始校准</button>
            </div>
        </div>
        
        <!-- 步骤4: 个人校准 -->
        <div class="step-container" id="calibrationStep">
            <div class="step-progress">
                <div class="progress-dot completed"></div>
                <div class="progress-dot completed"></div>
                <div class="progress-dot completed"></div>
                <div class="progress-dot active"></div>
                <div class="progress-dot"></div>
            </div>
            
            <h2 class="step-title">个人化校准</h2>
            <p class="step-subtitle">保持中性表情2秒钟，建立您的面部基线</p>
            
            <div class="calibration-content">
                <div class="video-container">
                    <div class="video-wrapper">
                        <video id="videoElement2" autoplay muted playsinline></video>
                        <canvas id="beautifiedCanvas2"></canvas>
                        <canvas id="overlayCanvas2"></canvas>
                        <div class="video-status" id="videoStatus2">准备校准...</div>
                        <div class="countdown-overlay" id="countdownOverlay2">准备</div>
                        
                        <div class="beauty-controls">
                            <div class="beauty-toggle">
                                <div class="beauty-switch" id="beautySwitch2" onclick="toggleBeauty()">
                                    <div class="beauty-switch-knob"></div>
                                </div>
                                <span class="beauty-label">美颜</span>
                            </div>
                            
                            <div class="beauty-slider" id="smoothSlider2">
                                <div class="beauty-slider-label">磨皮</div>
                                <input type="range" min="0" max="100" value="50" id="smoothRange2" oninput="updateBeauty()">
                            </div>
                            
                            <div class="beauty-slider" id="brightnessSlider2">
                                <div class="beauty-slider-label">亮度</div>
                                <input type="range" min="-50" max="50" value="10" id="brightnessRange2" oninput="updateBeauty()">
                            </div>
                            
                            <div class="beauty-slider" id="contrastSlider2">
                                <div class="beauty-slider-label">对比</div>
                                <input type="range" min="-50" max="50" value="15" id="contrastRange2" oninput="updateBeauty()">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="training-progress">
                    <div class="training-progress-fill" id="calibrationProgress"></div>
                </div>
                
                <div id="calibrationInstructions" class="expression-tips">
                    保持放松的中性表情，不要微笑或皱眉
                </div>
            </div>
            
            <div class="btn-group">
                <button class="btn btn-secondary" onclick="prevStep()">返回</button>
                <button class="btn btn-primary" id="calibrationBtn" onclick="startCalibration()">开始校准</button>
            </div>
        </div>
        
        <!-- 步骤5: 表情训练 -->
        <div class="step-container" id="trainingStep">
            <div class="step-progress">
                <div class="progress-dot completed"></div>
                <div class="progress-dot completed"></div>
                <div class="progress-dot completed"></div>
                <div class="progress-dot completed"></div>
                <div class="progress-dot active"></div>
            </div>
            
            <h2 class="step-title">表情训练</h2>
            <p class="step-subtitle" id="trainingSubtitle">跟随指导完成表情练习</p>
            
            <div class="training-content">
                <div class="video-container">
                    <div class="video-wrapper">
                        <video id="videoElement3" autoplay muted playsinline></video>
                        <canvas id="beautifiedCanvas3"></canvas>
                        <canvas id="overlayCanvas3"></canvas>
                        <div class="video-status" id="videoStatus3">准备训练...</div>
                        <div class="countdown-overlay" id="countdownOverlay3">3</div>
                        
                        <div class="beauty-controls">
                            <div class="beauty-toggle">
                                <div class="beauty-switch" id="beautySwitch3" onclick="toggleBeauty()">
                                    <div class="beauty-switch-knob"></div>
                                </div>
                                <span class="beauty-label">美颜</span>
                            </div>
                            
                            <div class="beauty-slider" id="smoothSlider3">
                                <div class="beauty-slider-label">磨皮</div>
                                <input type="range" min="0" max="100" value="50" id="smoothRange3" oninput="updateBeauty()">
                            </div>
                            
                            <div class="beauty-slider" id="brightnessSlider3">
                                <div class="beauty-slider-label">亮度</div>
                                <input type="range" min="-50" max="50" value="10" id="brightnessRange3" oninput="updateBeauty()">
                            </div>
                            
                            <div class="beauty-slider" id="contrastSlider3">
                                <div class="beauty-slider-label">对比</div>
                                <input type="range" min="-50" max="50" value="15" id="contrastRange3" oninput="updateBeauty()">
                            </div>
                        </div>
                    </div>
                    
                    <div class="training-progress">
                        <div class="training-progress-fill" id="trainingProgress"></div>
                    </div>
                </div>
                
                <div class="expression-guide">
                    <div class="expression-demo" id="expressionDemo">😊</div>
                    <div class="expression-text" id="expressionText">自然微笑</div>
                    <div class="expression-tips" id="expressionTips">
                        嘴角自然上扬，保持2秒钟
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn btn-secondary" id="skipBtn" onclick="nextExpression()">跳过</button>
                        <button class="btn btn-primary" id="startTrainingBtn" onclick="startExpression()">开始</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 结果屏幕 -->
        <div class="step-container" id="resultsStep">
            <h2 class="step-title">训练结果</h2>
            <p class="step-subtitle" id="resultSubtitle">您在影视镜头模式下的表现</p>
            
            <div class="results-content">
                <div class="score-display">
                    <div class="score-card" id="clarityCard">
                        <div class="score-icon">🎯</div>
                        <div class="score-label">清晰度</div>
                        <div class="score-value" id="clarityValue">85</div>
                        <div class="score-change" id="clarityChange">+5</div>
                    </div>
                    
                    <div class="score-card" id="consistencyCard">
                        <div class="score-icon">⚖️</div>
                        <div class="score-label">一致性</div>
                        <div class="score-value" id="consistencyValue">92</div>
                        <div class="score-change" id="consistencyChange">+3</div>
                    </div>
                    
                    <div class="score-card" id="intensityCard">
                        <div class="score-icon">⚡</div>
                        <div class="score-label">强度</div>
                        <div class="score-value" id="intensityValue">78</div>
                        <div class="score-change" id="intensityChange">-2</div>
                    </div>
                    
                    <div class="score-card" id="truthCard">
                        <div class="score-icon">💫</div>
                        <div class="score-label">真实性</div>
                        <div class="score-value" id="truthValue">88</div>
                        <div class="score-change" id="truthChange">+7</div>
                    </div>
                </div>
                
                <div class="feedback-section">
                    <div class="feedback-title">💡 专业指导建议</div>
                    <div id="feedbackContainer">
                        <div class="feedback-item">
                            <div class="feedback-icon">✨</div>
                            <div class="feedback-text">表现优秀！表情自然真实，继续保持这种状态。</div>
                        </div>
                        <div class="feedback-item">
                            <div class="feedback-icon">🎭</div>
                            <div class="feedback-text">影视表演风格掌握不错，可以尝试更有挑战的表情。</div>
                        </div>
                    </div>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-primary" id="makeShareVideoBtn">🎥 生成分享视频</button>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="restartTraining()">🔄 重新训练</button>
                    <button class="btn btn-primary" onclick="continueTraining()">➕ 继续练习</button>
                </div>
            </div>
        </div>
        
        <!-- 庆祝动画容器 -->
        <div class="celebration" id="celebrationContainer"></div>
    </div>

    <script>
        // 训练口令配置
        const TRAINING_COMMANDS = {
            smile_natural: {
                id: "smile_natural",
                text: "请做自然微笑并保持两秒",
                emoji: "😊",
                tips: "嘴角自然上扬，眼神温和",
                tts: true,
                duration: 2000,
                target: "smile",
                duchenne: false,
                difficulty: "E"
            },
            smile_duchenne: {
                id: "smile_duchenne", 
                text: "请做带眼笑并保持两秒",
                emoji: "😄",
                tips: "眼角微眯，嘴角上扬，真诚快乐",
                tts: true,
                duration: 2000,
                target: "smile",
                duchenne: true,
                difficulty: "M"
            },
            surprised: {
                id: "surprised",
                text: "请做惊讶表情",
                emoji: "😮",
                tips: "张口瞪眼，眉毛上扬",
                tts: true,
                duration: 1500,
                target: "surprised",
                duchenne: false,
                difficulty: "M"
            },
            sad: {
                id: "sad",
                text: "请做悲伤表情",
                emoji: "😢",
                tips: "眉心内收，嘴角下垂",
                tts: true,
                duration: 2000,
                target: "sad",
                duchenne: false,
                difficulty: "H"
            },
            angry: {
                id: "angry",
                text: "请做愤怒表情",
                emoji: "😠",
                tips: "眉毛压低，目光集中",
                tts: true,
                duration: 2000,
                target: "angry",
                duchenne: false,
                difficulty: "H"
            }
        };

        // 全局变量
        let faceMesh;
        let camera;
        let currentStep = 0;
        let selectedMode = null;
        let isRunning = false;
        let isCalibrating = false;
        let currentSession = null;
        let baseline = null;
        let metricsBuffer = [];
        let lastFrameTime = 0;
        let frameCount = 0;
        let currentExpressionIndex = 0;
        let trainingSequence = ['smile_natural', 'smile_duchenne', 'surprised', 'sad', 'angry'];
        let countdownTimer = null;
        let trainingTimer = null;
        
        // 美颜相关变量
        let beautyEnabled = false;
        let beautySettings = {
            smooth: 50,
            brightness: 10,
            contrast: 15
        };
        
        // DOM 元素获取
        const steps = ['welcomeStep', 'modeStep', 'cameraStep', 'calibrationStep', 'trainingStep'];
        const videoElements = ['videoElement', 'videoElement2', 'videoElement3'];
        const overlayCanvases = ['overlayCanvas', 'overlayCanvas2', 'overlayCanvas3'];
        
        // MediaPipe 关键点索引
        const LANDMARKS = {
            MOUTH: {
                LEFT_CORNER: 61,
                RIGHT_CORNER: 291,
                TOP: 13,
                BOTTOM: 14,
                UPPER_LIP: [12, 15, 16, 17, 18, 200],
                LOWER_LIP: [146, 91, 181, 84, 17, 314, 405, 320, 307, 375]
            },
            LEFT_EYE: {
                TOP: 159,
                BOTTOM: 145,
                LEFT: 33,
                RIGHT: 133,
                OUTLINE: [33, 7, 163, 144, 145, 153, 154, 155, 133, 173, 157, 158, 159, 160, 161, 246]
            },
            RIGHT_EYE: {
                TOP: 386,
                BOTTOM: 374,
                LEFT: 362,
                RIGHT: 263,
                OUTLINE: [362, 382, 381, 380, 374, 373, 390, 249, 263, 466, 388, 387, 386, 385, 384, 398]
            },
            LEFT_EYEBROW: {
                INNER: 55,
                OUTER: 46,
                CENTER: 70
            },
            RIGHT_EYEBROW: {
                INNER: 285,
                OUTER: 276,
                CENTER: 300
            },
            NOSE_TIP: 1
        };

        // 步骤导航函数
        async function nextStep() {
            if (currentStep < steps.length - 1) {
                document.getElementById(steps[currentStep]).classList.remove('active');
                currentStep++;
                document.getElementById(steps[currentStep]).classList.add('active');
                
                // 特殊处理
                if (currentStep === 2) { // 摄像头准备步骤
                    initializeCamera();
                } else if (currentStep === 3) { // 校准步骤
                    await setupCalibrationVideo();
                } else if (currentStep === 4) { // 训练步骤
                    await setupTrainingVideo();
                }
            }
        }

        function prevStep() {
            if (currentStep > 0) {
                document.getElementById(steps[currentStep]).classList.remove('active');
                currentStep--;
                document.getElementById(steps[currentStep]).classList.add('active');
            }
        }

        // 模式选择
        function selectMode(mode) {
            selectedMode = mode;
            
            // 更新UI
            document.querySelectorAll('.mode-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            event.target.closest('.mode-card').classList.add('selected');
            document.getElementById('modeNextBtn').disabled = false;
        }

        // 状态更新
        function updateStatus(message, type = 'ready') {
            const indicator = document.getElementById('statusIndicator');
            indicator.textContent = message;
            indicator.className = `status-indicator status-${type}`;
        }

        // 摄像头初始化
        async function initializeCamera() {
            try {
                updateStatus('启动摄像头...', 'running');
                
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        width: 640, 
                        height: 480,
                        facingMode: 'user'
                    }
                });
                
                // 为所有视频元素设置流
                videoElements.forEach(id => {
                    const video = document.getElementById(id);
                    if (video) {
                        video.srcObject = stream;
                        video.onloadedmetadata = () => {
                            const canvasId = id.replace('videoElement', 'overlayCanvas') || 'overlayCanvas';
                            const canvas = document.getElementById(canvasId);
                            if (canvas) {
                                canvas.width = video.videoWidth;
                                canvas.height = video.videoHeight;
                            }
                        };
                    }
                });
                
                await initializeFaceMesh();
                updateStatus('摄像头就绪', 'ready');
                document.getElementById('cameraNextBtn').disabled = false;
                
            } catch (error) {
                console.error('摄像头初始化失败:', error);
                updateStatus('摄像头访问失败', 'error');
            }
        }

        async function initializeFaceMesh() {
            faceMesh = new FaceMesh({
                locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`
            });

            faceMesh.setOptions({
                maxNumFaces: 1,
                refineLandmarks: true,
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });

            faceMesh.onResults(onFaceMeshResults);

            // 初始相机设置用于摄像头测试步骤
            camera = new Camera(document.getElementById('videoElement'), {
                onFrame: async () => {
                    const video = document.getElementById('videoElement');
                    if (video && video.videoWidth > 0) {
                        await faceMesh.send({image: video});
                    }
                },
                width: 640,
                height: 480
            });

            camera.start();
        }

        function getCurrentVideo() {
            const activeStep = document.querySelector('.step-container.active');
            if (activeStep) {
                const video = activeStep.querySelector('video');
                if (isCalibrating && video) {
                    console.log('校准中获取视频元素:', video.id, 'from step:', activeStep.id);
                }
                return video;
            }
            return document.getElementById('videoElement');
        }
        
        function getCurrentProcessedCanvas() {
            const activeStep = document.querySelector('.step-container.active');
            if (activeStep) {
                const canvas = activeStep.querySelector('[id*="beautifiedCanvas"]');
                if (isCalibrating) {
                    console.log('校准中获取canvas:', canvas ? canvas.id : 'null', 'activeStep:', activeStep.id);
                }
                return canvas;
            }
            return document.getElementById('beautifiedCanvas');
        }

        function getCurrentCanvas() {
            const activeStep = document.querySelector('.step-container.active');
            if (activeStep) {
                const canvas = activeStep.querySelector('canvas');
                return canvas;
            }
            return document.getElementById('overlayCanvas');
        }

        function onFaceMeshResults(results) {
            const now = performance.now();
            
            // 调试：校准期间MediaPipe是否在工作
            if (isCalibrating && Math.random() < 0.1) { // 10%概率打印
                console.log('MediaPipe onFaceMeshResults 被调用，landmarks:', results.multiFaceLandmarks?.length || 0);
            }
            
            // 更新FPS (简化版)
            frameCount++;
            if (now - lastFrameTime >= 1000) {
                lastFrameTime = now;
                frameCount = 0;
            }

            // 获取当前活动的canvas
            const canvas = getCurrentCanvas();
            if (!canvas) {
                if (isCalibrating) {
                    console.error('校准中无法获取当前canvas');
                }
                return;
            }
            
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
                const landmarks = results.multiFaceLandmarks[0];
                
                // 绘制覆盖层
                drawOverlay(ctx, landmarks, canvas);
                
                // 提取特征
                const metrics = extractMetrics(landmarks);
                
                // 收集训练数据
                if ((isRunning || isCalibrating) && metrics) {
                    metricsBuffer.push({
                        timestamp: now,
                        metrics: metrics
                    });
                    
                    // 调试信息
                    if (isCalibrating && metricsBuffer.length % 5 === 0) {
                        console.log(`校准进行中，已收集 ${metricsBuffer.length} 个数据点`, metrics);
                    }
                } else if (isCalibrating) {
                    // 调试：如果在校准但没有收集到数据
                    console.log('校准中但未收集到有效数据，metrics:', metrics);
                }
                
                // 更新视频状态
                updateVideoStatus(true);
            } else {
                // 调试：校准期间未检测到面部
                if (isCalibrating) {
                    console.log('校准中未检测到面部landmarks');
                }
                updateVideoStatus(false);
            }
        }

        function updateVideoStatus(faceDetected) {
            const activeStep = document.querySelector('.step-container.active');
            if (activeStep) {
                const statusElement = activeStep.querySelector('.video-status');
                if (statusElement) {
                    statusElement.textContent = faceDetected ? '检测到面部' : '未检测到面部';
                    statusElement.style.color = faceDetected ? '#4ecdc4' : '#ff6b6b';
                }
            }
        }

        // 绘制覆盖层
        function drawOverlay(ctx, landmarks, canvas) {
            ctx.strokeStyle = '#4ecdc4';
            ctx.lineWidth = 2;

            // 绘制嘴部轮廓
            drawLandmarkContour(ctx, LANDMARKS.MOUTH.UPPER_LIP, landmarks, canvas, '#4ecdc4');
            drawLandmarkContour(ctx, LANDMARKS.MOUTH.LOWER_LIP, landmarks, canvas, '#4ecdc4');

            // 绘制眼部轮廓
            drawLandmarkContour(ctx, LANDMARKS.LEFT_EYE.OUTLINE, landmarks, canvas, '#45b7d1');
            drawLandmarkContour(ctx, LANDMARKS.RIGHT_EYE.OUTLINE, landmarks, canvas, '#45b7d1');
        }

        function drawLandmarkContour(ctx, indices, landmarks, canvas, color) {
            if (!indices || !landmarks) return;
            
            ctx.strokeStyle = color;
            ctx.beginPath();
            
            let started = false;
            indices.forEach(idx => {
                if (landmarks[idx]) {
                    const point = landmarks[idx];
                    const x = point.x * canvas.width;
                    const y = point.y * canvas.height;
                    
                    if (!started) {
                        ctx.moveTo(x, y);
                        started = true;
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
            });
            
            ctx.closePath();
            ctx.stroke();
        }

        // 特征提取 (简化版)
        function extractMetrics(landmarks) {
            if (!landmarks || landmarks.length < 468) return null;

            try {
                const mouth = {
                    leftCorner: landmarks[LANDMARKS.MOUTH.LEFT_CORNER],
                    rightCorner: landmarks[LANDMARKS.MOUTH.RIGHT_CORNER], 
                    top: landmarks[LANDMARKS.MOUTH.TOP],
                    bottom: landmarks[LANDMARKS.MOUTH.BOTTOM]
                };

                const eyes = {
                    leftTop: landmarks[LANDMARKS.LEFT_EYE.TOP],
                    leftBottom: landmarks[LANDMARKS.LEFT_EYE.BOTTOM],
                    rightTop: landmarks[LANDMARKS.RIGHT_EYE.TOP],
                    rightBottom: landmarks[LANDMARKS.RIGHT_EYE.BOTTOM]
                };

                const distance = (p1, p2) => Math.sqrt(Math.pow(p1.x - p2.x, 2) + Math.pow(p1.y - p2.y, 2));

                const mouthWidth = distance(mouth.leftCorner, mouth.rightCorner);
                const mouthHeight = distance(mouth.top, mouth.bottom);
                const mouthRatio = mouthWidth / (mouthHeight + 0.001);
                const mouthOpen = mouthHeight / (mouthWidth + 0.001);

                const leftEAR = distance(eyes.leftTop, eyes.leftBottom) / distance(landmarks[LANDMARKS.LEFT_EYE.LEFT], landmarks[LANDMARKS.LEFT_EYE.RIGHT]);
                const rightEAR = distance(eyes.rightTop, eyes.rightBottom) / distance(landmarks[LANDMARKS.RIGHT_EYE.LEFT], landmarks[LANDMARKS.RIGHT_EYE.RIGHT]);
                const eyeEAR = (leftEAR + rightEAR) / 2;

                return {
                    mouthRatio,
                    mouthOpen,
                    eyeEAR,
                    symMouth: 1 - Math.min(1, Math.abs(mouth.leftCorner.y - mouth.rightCorner.y) * 1000),
                    poseYawProxy: 1 - Math.min(1, Math.abs(landmarks[LANDMARKS.NOSE_TIP].x - 0.5) * 2),
                    illumScore: 0.8 // 简化
                };
            } catch (error) {
                console.error('特征提取失败:', error);
                return null;
            }
        }

        // 校准功能
        async function setupCalibrationVideo() {
            // 校准页面视频设置
            document.getElementById('calibrationInstructions').textContent = '保持放松的中性表情，不要微笑或皱眉';
            
            // 强制重启相机并绑定到校准视频元素
            if (camera) {
                camera.stop();
            }
            
            // 为校准步骤重新创建相机
            camera = new Camera(document.getElementById('videoElement2'), {
                onFrame: async () => {
                    const video = document.getElementById('videoElement2');
                    if (video && video.videoWidth > 0) {
                        if (isCalibrating && Math.random() < 0.05) {
                            console.log('校准中向MediaPipe发送帧，视频尺寸:', video.videoWidth, 'x', video.videoHeight);
                        }
                        await faceMesh.send({image: video});
                    } else if (isCalibrating) {
                        console.warn('校准中视频元素未准备好:', video ? 'no width' : 'no video');
                    }
                },
                width: 640,
                height: 480
            });
            
            camera.start();
            renderBeautifiedVideo();
            
            console.log('校准页面设置完成');
        }

        function startCalibration() {
            if (isCalibrating) return;
            
            console.log('开始校准流程...');
            console.log('MediaPipe状态 - faceMesh:', !!faceMesh, 'camera:', !!camera);
            console.log('当前视频元素状态:', document.getElementById('videoElement2')?.videoWidth || 'N/A');
            
            isCalibrating = true;
            metricsBuffer = [];
            
            document.getElementById('calibrationBtn').disabled = true;
            updateStatus('校准中...', 'running');
            
            // 倒计时
            let countdown = 3;
            const countdownElement = document.getElementById('countdownOverlay2');
            const progressElement = document.getElementById('calibrationProgress');
            
            countdownElement.textContent = countdown;
            countdownElement.classList.add('show');
            
            const countdownInterval = setInterval(() => {
                countdown--;
                if (countdown > 0) {
                    countdownElement.textContent = countdown;
                } else {
                    countdownElement.textContent = '开始';
                    clearInterval(countdownInterval);
                    
                    // 开始校准
                    setTimeout(() => {
                        countdownElement.classList.remove('show');
                        startCalibrationCapture();
                    }, 500);
                }
            }, 1000);
        }

        function startCalibrationCapture() {
            const duration = 2000;
            const startTime = performance.now();
            const progressElement = document.getElementById('calibrationProgress');
            
            const updateProgress = () => {
                const elapsed = performance.now() - startTime;
                const progress = Math.min(100, (elapsed / duration) * 100);
                progressElement.style.width = `${progress}%`;
                
                if (elapsed < duration) {
                    requestAnimationFrame(updateProgress);
                } else {
                    finishCalibration();
                }
            };
            
            updateProgress();
        }

        function finishCalibration() {
            isCalibrating = false;
            
            console.log(`校准结束，收集到 ${metricsBuffer.length} 个数据点`);
            
            if (metricsBuffer.length > 0) {
                baseline = calculateBaseline(metricsBuffer);
                console.log('计算的基线数据:', baseline);
                updateStatus('校准完成', 'ready');
                
                // 显示成功并自动进入下一步
                document.getElementById('calibrationInstructions').innerHTML = 
                    '✅ 校准成功！建立了您的个人面部基线<br>现在可以开始表情训练了';
                
                setTimeout(() => {
                    nextStep();
                }, 2000);
                
            } else {
                console.error('校准失败：未收集到面部数据');
                updateStatus('校准失败', 'error');
                document.getElementById('calibrationBtn').disabled = false;
                document.getElementById('calibrationInstructions').textContent = '未检测到面部，请重试校准';
            }
        }

        function calculateBaseline(buffer) {
            const metrics = buffer.map(item => item.metrics).filter(m => m !== null);
            if (metrics.length === 0) return null;
            
            const average = arr => arr.reduce((sum, val) => sum + val, 0) / arr.length;
            
            return {
                mouthRatio: average(metrics.map(m => m.mouthRatio)),
                eyeEAR: average(metrics.map(m => m.eyeEAR)),
                mouthOpen: average(metrics.map(m => m.mouthOpen))
            };
        }

        // 训练功能
        async function setupTrainingVideo() {
            // 训练页面视频设置 - 为训练步骤重新创建相机
            if (camera) {
                camera.stop();
            }
            
            // 为训练步骤重新创建相机
            camera = new Camera(document.getElementById('videoElement3'), {
                onFrame: async () => {
                    const video = document.getElementById('videoElement3');
                    if (video && video.videoWidth > 0) {
                        await faceMesh.send({image: video});
                    }
                },
                width: 640,
                height: 480
            });
            
            camera.start();
            loadCurrentExpression();
        }

        function loadCurrentExpression() {
            const commandId = trainingSequence[currentExpressionIndex];
            const command = TRAINING_COMMANDS[commandId];
            
            if (!command) {
                // 训练完成，显示结果
                showFinalResults();
                return;
            }
            
            document.getElementById('expressionDemo').textContent = command.emoji;
            document.getElementById('expressionText').textContent = command.text.replace('请做', '').replace('并保持两秒', '').replace('并保持一秒半', '');
            document.getElementById('expressionTips').textContent = command.tips;
            document.getElementById('trainingSubtitle').textContent = `表情 ${currentExpressionIndex + 1}/${trainingSequence.length}: ${command.text.replace('请做', '').replace('并保持两秒', '').replace('并保持一秒半', '')}`;
            
            // 重置按钮状态
            document.getElementById('startTrainingBtn').disabled = false;
            document.getElementById('startTrainingBtn').textContent = '开始';
        }

        function startExpression() {
            if (isRunning) return;
            
            const commandId = trainingSequence[currentExpressionIndex];
            const command = TRAINING_COMMANDS[commandId];
            
            isRunning = true;
            metricsBuffer = [];
            
            document.getElementById('startTrainingBtn').disabled = true;
            document.getElementById('skipBtn').disabled = true;
            updateStatus('训练中...', 'running');
            
            // TTS 播报
            if (command.tts && 'speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(command.text);
                speechSynthesis.speak(utterance);
            }
            
            // 倒计时
            let countdown = 3;
            const countdownElement = document.getElementById('countdownOverlay3');
            countdownElement.textContent = countdown;
            countdownElement.classList.add('show');
            
            countdownTimer = setInterval(() => {
                countdown--;
                if (countdown > 0) {
                    countdownElement.textContent = countdown;
                } else {
                    countdownElement.textContent = '开始!';
                    clearInterval(countdownTimer);
                    
                    setTimeout(() => {
                        countdownElement.classList.remove('show');
                        startExpressionCapture(command);
                    }, 500);
                }
            }, 1000);
        }

        function startExpressionCapture(command) {
            const duration = command.duration;
            const startTime = performance.now();
            const progressElement = document.getElementById('trainingProgress');
            
            currentSession = {
                mode: selectedMode,
                command: command,
                startTime: startTime
            };
            
            const updateProgress = () => {
                const elapsed = performance.now() - startTime;
                const progress = Math.min(100, (elapsed / duration) * 100);
                progressElement.style.width = `${progress}%`;
                
                if (elapsed < duration) {
                    requestAnimationFrame(updateProgress);
                } else {
                    finishExpression();
                }
            };
            
            updateProgress();
        }

        function finishExpression() {
            isRunning = false;
            currentSession.endTime = performance.now();
            
            // 分析这次表情的结果
            if (metricsBuffer.length > 0) {
                const result = analyzeExpression();
                showExpressionResult(result);
            }
            
            // 准备下一个表情或完成训练
            setTimeout(() => {
                currentExpressionIndex++;
                if (currentExpressionIndex < trainingSequence.length) {
                    loadCurrentExpression();
                } else {
                    showFinalResults();
                }
            }, 3000);
        }

        function nextExpression() {
            if (countdownTimer) clearInterval(countdownTimer);
            if (trainingTimer) clearInterval(trainingTimer);
            
            document.getElementById('countdownOverlay3').classList.remove('show');
            document.getElementById('trainingProgress').style.width = '0%';
            
            isRunning = false;
            currentExpressionIndex++;
            
            if (currentExpressionIndex < trainingSequence.length) {
                loadCurrentExpression();
            } else {
                showFinalResults();
            }
        }

        function analyzeExpression() {
            const validMetrics = metricsBuffer.map(item => item.metrics).filter(m => m !== null);
            if (validMetrics.length === 0) return null;
            
            const average = arr => arr.reduce((sum, val) => sum + val, 0) / arr.length;
            
            const avgMetrics = {
                mouthRatio: average(validMetrics.map(m => m.mouthRatio)),
                eyeEAR: average(validMetrics.map(m => m.eyeEAR)),
                mouthOpen: average(validMetrics.map(m => m.mouthOpen)),
                symMouth: average(validMetrics.map(m => m.symMouth))
            };
            
            // 简化评分
            const scores = calculateSimpleScores(avgMetrics, currentSession.command.target);
            
            return {
                scores: scores,
                metrics: avgMetrics
            };
        }

        function calculateSimpleScores(metrics, target) {
            let match = 50;
            
            // 根据表情类型计算匹配度
            switch (target) {
                case 'smile':
                    const smileIntensity = baseline ? 
                        (metrics.mouthRatio - baseline.mouthRatio) : 
                        (metrics.mouthRatio - 2.5);
                    match = Math.max(0, Math.min(100, smileIntensity * 30 + 60));
                    break;
                    
                case 'surprised':
                    match = Math.max(0, Math.min(100, metrics.mouthOpen * 150 + 30));
                    break;
                    
                case 'sad':
                case 'angry':
                    match = Math.max(30, Math.min(90, 70 + Math.random() * 20));
                    break;
                    
                default:
                    match = Math.max(40, Math.min(90, 60 + Math.random() * 30));
            }
            
            return {
                clarity: Math.round(match + Math.random() * 10 - 5),
                consistency: Math.round(metrics.symMouth * 100),
                intensity: Math.round(Math.min(100, match * (selectedMode === 'stage' ? 1.1 : 0.9))),
                truth: Math.round(Math.max(60, match - 5 + Math.random() * 10))
            };
        }

        function showExpressionResult(result) {
            if (!result) return;
            
            const avgScore = (result.scores.clarity + result.scores.consistency + result.scores.intensity + result.scores.truth) / 4;
            
            // 更新表情指导区域显示结果
            document.getElementById('expressionDemo').textContent = avgScore > 80 ? '🎉' : avgScore > 60 ? '👍' : '💪';
            document.getElementById('expressionText').textContent = avgScore > 80 ? '优秀!' : avgScore > 60 ? '良好!' : '继续努力!';
            document.getElementById('expressionTips').innerHTML = `
                清晰度: ${result.scores.clarity} | 一致性: ${result.scores.consistency}<br>
                强度: ${result.scores.intensity} | 真实性: ${result.scores.truth}
            `;
            
            // 如果表现优秀，播放庆祝动画
            if (avgScore > 85) {
                showCelebration();
            }
            
            updateStatus('表情完成', 'ready');
            document.getElementById('skipBtn').disabled = false;
        }

        function showCelebration() {
            const container = document.getElementById('celebrationContainer');
            
            // 创建彩带效果
            for (let i = 0; i < 20; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.background = ['#4ecdc4', '#45b7d1', '#96ceb4', '#ff6b6b'][Math.floor(Math.random() * 4)];
                confetti.style.animationDelay = Math.random() * 2 + 's';
                container.appendChild(confetti);
                
                setTimeout(() => confetti.remove(), 3000);
            }
        }

        function showFinalResults() {
            // 切换到结果页面
            document.getElementById('trainingStep').classList.remove('active');
            document.getElementById('resultsStep').classList.add('active');
            
            // 更新结果数据 (模拟数据)
            const results = {
                clarity: 78 + Math.floor(Math.random() * 20),
                consistency: 82 + Math.floor(Math.random() * 15),
                intensity: selectedMode === 'stage' ? 88 + Math.floor(Math.random() * 12) : 72 + Math.floor(Math.random() * 18),
                truth: 85 + Math.floor(Math.random() * 15)
            };
            
            updateResultsDisplay(results);
            generateFeedback(results);
            updateStatus('训练完成', 'ready');
        }

        function updateResultsDisplay(results) {
            // 更新分数显示
            document.getElementById('clarityValue').textContent = results.clarity;
            document.getElementById('consistencyValue').textContent = results.consistency;
            document.getElementById('intensityValue').textContent = results.intensity;
            document.getElementById('truthValue').textContent = results.truth;
            
            // 更新分数卡片样式
            updateScoreCard('clarityCard', results.clarity);
            updateScoreCard('consistencyCard', results.consistency);
            updateScoreCard('intensityCard', results.intensity);
            updateScoreCard('truthCard', results.truth);
            
            // 更新模式显示
            document.getElementById('resultSubtitle').textContent = 
                `您在${selectedMode === 'film' ? '影视镜头' : '舞台表演'}模式下的表现`;
        }

        function updateScoreCard(cardId, score) {
            const card = document.getElementById(cardId);
            card.classList.remove('excellent', 'good', 'needs-work');
            
            if (score >= 85) {
                card.classList.add('excellent');
            } else if (score >= 70) {
                card.classList.add('good');
            } else {
                card.classList.add('needs-work');
            }
        }

        function generateFeedback(results) {
            const feedback = [];
            const avgScore = (results.clarity + results.consistency + results.intensity + results.truth) / 4;
            
            if (avgScore >= 85) {
                feedback.push({
                    icon: '🎉',
                    text: '出色的表现！您的表情控制能力已经达到专业水准。'
                });
            } else if (avgScore >= 75) {
                feedback.push({
                    icon: '👍',
                    text: '表现良好！继续练习会有更大的进步空间。'
                });
            } else {
                feedback.push({
                    icon: '💪',
                    text: '还有提升空间，建议多练习基础表情。'
                });
            }
            
            if (results.intensity < 70 && selectedMode === 'stage') {
                feedback.push({
                    icon: '🎭',
                    text: '舞台表演需要更大的表情幅度，让后排观众也能看清。'
                });
            }
            
            if (results.intensity > 85 && selectedMode === 'film') {
                feedback.push({
                    icon: '🎬',
                    text: '影视表演中过度夸张可能显得不自然，适当收敛会更好。'
                });
            }
            
            if (results.truth < 75) {
                feedback.push({
                    icon: '💫',
                    text: '表情的真实感有待提高，试着从内心感受情绪。'
                });
            }
            
            // 显示反馈
            const container = document.getElementById('feedbackContainer');
            container.innerHTML = '';
            
            feedback.forEach(item => {
                const feedbackElement = document.createElement('div');
                feedbackElement.className = 'feedback-item';
                feedbackElement.innerHTML = `
                    <div class="feedback-icon">${item.icon}</div>
                    <div class="feedback-text">${item.text}</div>
                `;
                container.appendChild(feedbackElement);
            });
        }

        // 重新开始训练
        function restartTraining() {
            currentExpressionIndex = 0;
            currentStep = 0;
            selectedMode = null;
            baseline = null;
            
            // 重置UI
            document.getElementById('resultsStep').classList.remove('active');
            document.getElementById('welcomeStep').classList.add('active');
            
            // 重置模式选择
            document.querySelectorAll('.mode-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.getElementById('modeNextBtn').disabled = true;
            
            updateStatus('重新开始', 'ready');
        }

        // 继续训练
        function continueTraining() {
            currentExpressionIndex = 0;
            
            // 回到训练步骤
            document.getElementById('resultsStep').classList.remove('active');
            document.getElementById('trainingStep').classList.add('active');
            currentStep = 4;
            
            loadCurrentExpression();
            updateStatus('继续训练', 'ready');
        }

        // 美颜功能函数
        function toggleBeauty() {
            beautyEnabled = !beautyEnabled;
            
            // 只更新美颜开关的状态，不影响镜像开关
            const beautySwitch = document.getElementById('beautySwitch');
            if (beautySwitch) {
                if (beautyEnabled) {
                    beautySwitch.classList.add('active');
                } else {
                    beautySwitch.classList.remove('active');
                }
            }
            
            // 显示/隐藏滑块
            document.querySelectorAll('.beauty-slider').forEach(slider => {
                if (beautyEnabled) {
                    slider.classList.add('active');
                } else {
                    slider.classList.remove('active');
                }
            });
            
            updateBeauty();
        }
        
        
        function updateBeauty() {
            if (!beautyEnabled) return;
            
            // 获取当前激活步骤的滑块值
            const activeStep = document.querySelector('.step-container.active');
            if (activeStep) {
                const smoothRange = activeStep.querySelector('[id*="smoothRange"]');
                const brightnessRange = activeStep.querySelector('[id*="brightnessRange"]');
                const contrastRange = activeStep.querySelector('[id*="contrastRange"]');
                
                if (smoothRange) beautySettings.smooth = parseInt(smoothRange.value);
                if (brightnessRange) beautySettings.brightness = parseInt(brightnessRange.value);
                if (contrastRange) beautySettings.contrast = parseInt(contrastRange.value);
            }
        }
        
        function applyBeautyFilter(sourceCanvas, targetCanvas) {
            if (!beautyEnabled) {
                // 如果美颜关闭，直接复制原图
                const sourceCtx = sourceCanvas.getContext('2d');
                const targetCtx = targetCanvas.getContext('2d');
                targetCtx.clearRect(0, 0, targetCanvas.width, targetCanvas.height);
                targetCtx.drawImage(sourceCanvas, 0, 0);
                return;
            }
            
            const sourceCtx = sourceCanvas.getContext('2d');
            const targetCtx = targetCanvas.getContext('2d');
            
            // 获取图像数据
            const imageData = sourceCtx.getImageData(0, 0, sourceCanvas.width, sourceCanvas.height);
            const data = imageData.data;
            
            // 应用美颜效果
            for (let i = 0; i < data.length; i += 4) {
                let r = data[i];
                let g = data[i + 1];
                let b = data[i + 2];
                
                // 磨皮效果 (简化版高斯模糊)
                if (beautySettings.smooth > 0) {
                    const smoothFactor = beautySettings.smooth / 100 * 0.3;
                    r = r + (128 - r) * smoothFactor;
                    g = g + (128 - g) * smoothFactor;
                    b = b + (128 - b) * smoothFactor;
                }
                
                // 亮度调整
                const brightnessFactor = beautySettings.brightness / 50;
                r = Math.max(0, Math.min(255, r + brightnessFactor * 30));
                g = Math.max(0, Math.min(255, g + brightnessFactor * 30));
                b = Math.max(0, Math.min(255, b + brightnessFactor * 30));
                
                // 对比度调整
                const contrastFactor = (beautySettings.contrast + 50) / 50;
                r = Math.max(0, Math.min(255, (r - 128) * contrastFactor + 128));
                g = Math.max(0, Math.min(255, (g - 128) * contrastFactor + 128));
                b = Math.max(0, Math.min(255, (b - 128) * contrastFactor + 128));
                
                data[i] = r;
                data[i + 1] = g;
                data[i + 2] = b;
            }
            
            // 将处理后的数据绘制到目标画布
            targetCtx.putImageData(imageData, 0, 0);
        }
        
        function renderBeautifiedVideo() {
            const activeStep = document.querySelector('.step-container.active');
            if (!activeStep) return;
            
            // 调试信息
            if (isCalibrating && Math.random() < 0.01) { // 1%概率打印，避免日志过多
                console.log('renderBeautifiedVideo运行中，activeStep:', activeStep.id);
            }
            
            const video = activeStep.querySelector('video');
            const beautifiedCanvas = activeStep.querySelector('[id*="beautifiedCanvas"]');
            
            if (!video || !beautifiedCanvas || video.videoWidth === 0) {
                requestAnimationFrame(renderBeautifiedVideo);
                return;
            }
            
            // 设置画布尺寸
            if (beautifiedCanvas.width !== video.videoWidth) {
                beautifiedCanvas.width = video.videoWidth;
                beautifiedCanvas.height = video.videoHeight;
            }
            
            const ctx = beautifiedCanvas.getContext('2d');
            
            if (beautyEnabled) {
                // 先绘制视频帧到临时画布
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = video.videoWidth;
                tempCanvas.height = video.videoHeight;
                const tempCtx = tempCanvas.getContext('2d');
                tempCtx.drawImage(video, 0, 0);
                
                // 应用美颜滤镜
                applyBeautyFilter(tempCanvas, beautifiedCanvas);
            } else {
                // 直接绘制原始视频
                ctx.drawImage(video, 0, 0);
            }
            
            // 继续下一帧
            requestAnimationFrame(renderBeautifiedVideo);
        }

        // === Recording state ===
        let recorder, recordedChunks = [];
        let mixedStream;

        // 如果需要采集麦克风，请将此项设为 true（默认 false 仅录画面）
        const ENABLE_MIC = false;

        // 用美颜后的画布作为视频源（与页面一致：#beautifiedCanvas3）
        function getCanvasStream() {
            const canvas = document.getElementById('beautifiedCanvas3');
            // 30fps 可按需调整
            return canvas.captureStream(30);
        }

        async function startRecording() {
            // 画面流
            const canvasStream = getCanvasStream();

            // 可选：合并麦克风音频（移动端需要 HTTPS+手势触发）
            if (ENABLE_MIC) {
                const mic = await navigator.mediaDevices.getUserMedia({ audio: true });
                mixedStream = new MediaStream([
                    ...canvasStream.getVideoTracks(),
                    ...mic.getAudioTracks()
                ]);
            } else {
                mixedStream = canvasStream;
            }

            recordedChunks = [];
            recorder = new MediaRecorder(mixedStream, { mimeType: 'video/webm; codecs=vp9,opus' });
            recorder.ondataavailable = e => { if (e.data.size > 0) recordedChunks.push(e.data); };
            recorder.onstop = async () => {
                const blob = new Blob(recordedChunks, { type: 'video/webm' });
                // 存到 sessionStorage，供下一页读取
                const b64 = await blobToBase64(blob);
                sessionStorage.setItem('lastTrainingVideo_b64', b64);
                // 跳转到预览+分享页
                window.location.href = 'video-share.html';
            };
            recorder.start();
        }

        function stopRecordingAndGo() {
            if (recorder && recorder.state !== 'inactive') {
                recorder.stop();
            } else {
                // 兜底：没有录到就提示
                alert('No video recorded — please try training again.');
            }
        }

        function blobToBase64(blob) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.readAsDataURL(blob); // data:URL(base64)
            });
        }

        // === 将录制与"训练开始/结束"绑定 ===
        // 当用户点击"Start"开始某个表情训练时开始录制；当训练序列全部完成进入 results 时停止录制。
        // 如果你的代码里已有训练状态机，请在合适的起止钩子里调用：startRecording() / stopRecordingAndGo()。
        // 暂时提供最小实现：当点击开始训练按钮时开启；当显示结果页（#resultsStep）时停止。
        (function wireRecording() {
            // 开始按钮（英文页 id='startTrainingBtn'；中文页一致或名为"开始"按钮）：
            const startBtn = document.getElementById('startTrainingBtn');
            if (startBtn) {
                startBtn.addEventListener('click', () => {
                    // 防多次启动
                    if (!recorder || recorder.state === 'inactive') {
                        startRecording();
                    }
                }, { once: false });
            }

            // 注释掉自动跳转，让用户自己决定是否生成视频
            // const resultsStep = document.getElementById('resultsStep');
            // const observer = new MutationObserver(() => {
            //     if (resultsStep.classList.contains('active')) {
            //         stopRecordingAndGo();
            //     }
            // });
            // if (resultsStep) observer.observe(resultsStep, { attributes: true, attributeFilter: ['class'] });

            // 分享视频按钮事件
            const shareBtn = document.getElementById('makeShareVideoBtn');
            if (shareBtn) {
                shareBtn.addEventListener('click', () => {
                    // 若录制已结束会直接跳转；若仍在录制则先停止再跳转
                    stopRecordingAndGo();
                });
            }
        })();

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            updateStatus('欢迎使用表情训练教练', 'ready');
            // 启动美颜渲染循环
            renderBeautifiedVideo();
        });
    </script>
</body>
</html>