<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Share Training Video - Facial Expression Coach</title>
    <!-- FFmpeg.wasm for video generation -->
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.7/dist/umd/ffmpeg.js"></script>
    <!-- QRCode generation library -->
    <script src="https://unpkg.com/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            overflow-x: hidden;
        }

        .container {
            max-width: 800px;
            width: 90%;
            margin: 0 auto;
            padding: 2rem;
        }

        .header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            background: linear-gradient(45deg, #fff, #e0e7ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .video-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .video-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin: 0 auto 2rem auto;
            border-radius: 16px;
            overflow: hidden;
            background: #000;
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.3);
        }

        .video-player {
            width: 100%;
            height: auto;
            display: block;
            border-radius: 16px;
        }

        .video-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: opacity 0.3s ease;
        }

        .video-overlay.playing {
            opacity: 0;
            pointer-events: none;
        }

        .play-button {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 2rem;
        }

        .play-button:hover {
            transform: scale(1.1);
            background: rgba(255, 255, 255, 0.3);
        }

        .video-info {
            text-align: center;
            margin-bottom: 2rem;
        }

        .video-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-item {
            text-align: center;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .actions-section {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .actions-title {
            font-size: 1.3rem;
            font-weight: 600;
            text-align: center;
            margin-bottom: 2rem;
            color: #e0e7ff;
        }

        .btn-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .action-btn {
            padding: 1rem 1.5rem;
            border-radius: 16px;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            text-decoration: none;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .action-btn:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .action-btn:hover:before {
            left: 100%;
        }

        .btn-download {
            background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
            box-shadow: 0 4px 15px rgba(78, 205, 196, 0.3);
        }

        .btn-download:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(78, 205, 196, 0.4);
        }

        .btn-share {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            box-shadow: 0 4px 15px rgba(240, 147, 251, 0.3);
        }

        .btn-share:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(240, 147, 251, 0.4);
        }

        .btn-wechat {
            background: linear-gradient(135deg, #07c160 0%, #06b056 100%);
            box-shadow: 0 4px 15px rgba(7, 193, 96, 0.3);
        }

        .btn-wechat:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(7, 193, 96, 0.4);
        }

        .btn-back {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-back:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .success-message {
            display: none;
            text-align: center;
            padding: 1rem;
            background: rgba(78, 205, 196, 0.2);
            border-radius: 12px;
            border: 1px solid rgba(78, 205, 196, 0.3);
            margin-top: 1rem;
        }

        .qr-section {
            display: none;
            text-align: center;
            margin-top: 2rem;
            padding: 2rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 16px;
        }

        .qr-code {
            width: 200px;
            height: 200px;
            background: white;
            margin: 1rem auto;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
            font-size: 0.9rem;
        }

        /* Progress overlay */
        .progress-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .progress-overlay.show {
            display: flex;
        }

        .progress-content {
            text-align: center;
            color: white;
            max-width: 400px;
            padding: 2rem;
        }

        .progress-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #4ecdc4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .progress-message {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .progress-detail {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .container {
                width: 95%;
                padding: 1rem;
            }

            .header h1 {
                font-size: 2rem;
            }

            .video-section {
                padding: 1.5rem;
            }

            .btn-group {
                grid-template-columns: 1fr;
                gap: 0.8rem;
            }

            .video-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Animation effects */
        .fade-in {
            animation: fadeIn 0.6s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <div class="container fade-in">
        <div class="header">
            <h1>🎬 Training Video Generated</h1>
            <p>Your facial expression training highlights have been successfully recorded</p>
        </div>

        <div class="video-section">
            <div class="video-container">
                <video id="recordedVideo" class="video-player" muted>
                    <source src="" type="video/webm">
                    Your browser does not support video playback.
                </video>
                <div class="video-overlay" id="videoOverlay">
                    <div class="play-button">▶️</div>
                </div>
            </div>

            <div class="video-info">
                <h3 style="margin-bottom: 1rem; color: #e0e7ff;">✨ Your Expression Training Video</h3>
                <p style="color: #a0a9c0; text-align: center; line-height: 1.5;">
                    A personalized video generated from your expression training photos, showcasing your highlights during the training process
                </p>
            </div>
        </div>

        <div class="actions-section">
            <h3 class="actions-title">📱 Share Your Results</h3>
            
            <div class="btn-group">
                <button class="action-btn btn-download" id="downloadBtn">
                    <span>📥</span>
                    <span>Download Video</span>
                </button>
                
                <button class="action-btn btn-share" id="shareBtn">
                    <span>🔗</span>
                    <span>Quick Share</span>
                </button>
                
                <button class="action-btn btn-wechat" id="wechatBtn">
                    <span>💬</span>
                    <span>WeChat Share</span>
                </button>
                
                <a href="javascript:history.back()" class="action-btn btn-back">
                    <span>🔙</span>
                    <span>Back to Training</span>
                </a>
            </div>

            <div class="loading" id="loadingSection">
                <div class="spinner"></div>
                <p>Processing...</p>
            </div>

            <div class="success-message" id="successMessage">
                <span>✅</span>
                <span>Operation completed successfully!</span>
            </div>

            <div class="qr-section" id="qrSection">
                <h4 style="margin-bottom: 1rem;">WeChat QR Code Share</h4>
                <div class="qr-code" id="qrCode">
                    QR code will be displayed here
                </div>
                <p style="opacity: 0.8; font-size: 0.9rem;">Scan with WeChat to share to Moments</p>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let videoBlob = null;
        let videoUrl = null;
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadVideoFromStorage();
            setupEventListeners();
        });

        // Load photo data from sessionStorage
        function loadVideoFromStorage() {
            try {
                // First try to load new photo data
                console.log('Attempting to load photo data...');
                const capturedPhotosData = sessionStorage.getItem('capturedPhotos');
                console.log('Photo data in sessionStorage:', capturedPhotosData);
                
                if (capturedPhotosData) {
                    const photos = JSON.parse(capturedPhotosData);
                    console.log('Found photo data:', photos.length, 'photos', photos);
                    
                    // Generate video from photos
                    generateVideoFromPhotos(photos);
                    return;
                }
                
                // Compatible with old video data format
                const videoData = sessionStorage.getItem('recordedVideoBlob') || sessionStorage.getItem('lastTrainingVideo_b64');
                const trainingData = JSON.parse(sessionStorage.getItem('trainingData') || '{}');
                
                if (videoData) {
                    // Convert Base64 back to Blob
                    const byteCharacters = atob(videoData);
                    const byteNumbers = new Array(byteCharacters.length);
                    for (let i = 0; i < byteCharacters.length; i++) {
                        byteNumbers[i] = byteCharacters.charCodeAt(i);
                    }
                    const byteArray = new Uint8Array(byteNumbers);
                    videoBlob = new Blob([byteArray], { type: 'video/webm' });
                    
                    // Create video URL and set to video element
                    videoUrl = URL.createObjectURL(videoBlob);
                    const videoElement = document.getElementById('recordedVideo');
                    videoElement.src = videoUrl;
                    
                    // Update video info
                    updateVideoStats(videoBlob, trainingData);
                } else {
                    // No data, show error
                    showError('Training data not found, please redo expression training');
                }
            } catch (error) {
                console.error('Data loading failed:', error);
                showError('Data loading failed');
            }
        }
        
        // Generate video using FFmpeg.wasm
        let ffmpeg;
        
        async function generateVideoFromPhotos(photos) {
            if (photos.length === 0) {
                showError('No photo data found');
                return;
            }
            
            try {
                showProgress('Initializing video generator...');
                
                // Initialize FFmpeg
                if (!ffmpeg) {
                    ffmpeg = new FFmpeg.FFmpeg();
                    await ffmpeg.load({
                        coreURL: 'https://unpkg.com/@ffmpeg/core@0.12.6/dist/umd/ffmpeg-core.js'
                    });
                    console.log('FFmpeg loaded successfully');
                }
                
                showProgress('Processing photo data...');
                
                // Write photos to FFmpeg file system
                for (let i = 0; i < photos.length; i++) {
                    const photo = photos[i];
                    
                    // Convert base64 to Uint8Array
                    const base64Data = photo.dataUrl.split(',')[1];
                    const binaryString = atob(base64Data);
                    const bytes = new Uint8Array(binaryString.length);
                    for (let j = 0; j < binaryString.length; j++) {
                        bytes[j] = binaryString.charCodeAt(j);
                    }
                    
                    // Write to FFmpeg file system with sequence numbering
                    const filename = `image${String(i).padStart(3, '0')}.jpg`;
                    await ffmpeg.writeFile(filename, bytes);
                    console.log(`Writing photo ${i + 1}/${photos.length}: ${filename}`);
                }
                
                showProgress('Generating video...');
                
                // Generate video using FFmpeg - Purple theme
                // Each image displays for 2 seconds, generating a looping video
                await ffmpeg.exec([
                    '-framerate', '0.5', // 0.5fps = 2 seconds per image
                    '-i', 'image%03d.jpg',
                    '-vf', 'scale=640:480:force_original_aspect_ratio=decrease,pad=640:480:(ow-iw)/2:(oh-ih)/2:#6B46C1', // Purple background
                    '-pix_fmt', 'yuv420p',
                    '-c:v', 'libx264',
                    '-t', `${photos.length * 2}`, // Total duration
                    'output.mp4'
                ]);
                
                showProgress('Retrieving video data...');
                
                // Read generated video
                const data = await ffmpeg.readFile('output.mp4');
                videoBlob = new Blob([data.buffer], { type: 'video/mp4' });
                videoUrl = URL.createObjectURL(videoBlob);
                
                // Set video
                const videoElement = document.getElementById('recordedVideo');
                videoElement.src = videoUrl;
                
                // Clean FFmpeg file system
                for (let i = 0; i < photos.length; i++) {
                    const filename = `image${String(i).padStart(3, '0')}.jpg`;
                    try {
                        await ffmpeg.deleteFile(filename);
                    } catch (e) {
                        // Ignore deletion errors
                    }
                }
                await ffmpeg.deleteFile('output.mp4');
                
                // Update interface
                hideProgress();
                updateVideoStats(videoBlob, { photos: photos.length });
                console.log('✅ FFmpeg video generation successful!');
                
            } catch (error) {
                console.error('FFmpeg video generation failed:', error);
                hideProgress();
                
                // If FFmpeg fails, try backup method
                console.log('Trying backup video generation method...');
                try {
                    await generateVideoFallback(photos);
                } catch (fallbackError) {
                    console.error('Backup method also failed:', fallbackError);
                    showError('Video generation failed, please try again');
                }
            }
        }
        
        // Backup method: using Canvas + MediaRecorder
        async function generateVideoFallback(photos) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 640;
            canvas.height = 480;
            
            showProgress('Using backup method to generate video...');
            
            // Check MediaRecorder support
            if (!window.MediaRecorder) {
                throw new Error('Browser does not support video recording');
            }
            
            const stream = canvas.captureStream(25);
            const mediaRecorder = new MediaRecorder(stream, {
                mimeType: MediaRecorder.isTypeSupported('video/webm;codecs=vp9') ? 
                         'video/webm;codecs=vp9' : 'video/webm'
            });
            
            const chunks = [];
            mediaRecorder.ondataavailable = (e) => {
                if (e.data.size > 0) chunks.push(e.data);
            };
            
            return new Promise((resolve, reject) => {
                mediaRecorder.onstop = () => {
                    try {
                        videoBlob = new Blob(chunks, { type: 'video/webm' });
                        videoUrl = URL.createObjectURL(videoBlob);
                        
                        const videoElement = document.getElementById('recordedVideo');
                        videoElement.src = videoUrl;
                        
                        hideProgress();
                        updateVideoStats(videoBlob, { photos: photos.length });
                        console.log('✅ Backup method video generation successful!');
                        resolve();
                    } catch (error) {
                        reject(error);
                    }
                };
                
                mediaRecorder.onerror = reject;
                mediaRecorder.start();
                
                // Render each photo
                let currentIndex = 0;
                const renderInterval = setInterval(() => {
                    if (currentIndex >= photos.length) {
                        clearInterval(renderInterval);
                        setTimeout(() => mediaRecorder.stop(), 1000);
                        return;
                    }
                    
                    const img = new Image();
                    img.onload = () => {
                        // Purple gradient background
                        const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
                        gradient.addColorStop(0, '#8B5CF6'); // Light purple
                        gradient.addColorStop(1, '#6B46C1'); // Dark purple
                        ctx.fillStyle = gradient;
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        
                        // Draw photo centered
                        const scale = Math.min(canvas.width / img.width, canvas.height / img.height);
                        const width = img.width * scale;
                        const height = img.height * scale;
                        const x = (canvas.width - width) / 2;
                        const y = (canvas.height - height) / 2;
                        
                        ctx.drawImage(img, x, y, width, height);
                        
                        // Add purple glowing border to photo
                        ctx.shadowColor = '#A855F7';
                        ctx.shadowBlur = 15;
                        ctx.strokeStyle = '#A855F7';
                        ctx.lineWidth = 4;
                        ctx.strokeRect(x - 2, y - 2, width + 4, height + 4);
                        ctx.shadowBlur = 0; // Reset shadow
                        
                        // Add title - white text with purple border
                        ctx.fillStyle = '#FFFFFF';
                        ctx.strokeStyle = '#6B46C1';
                        ctx.lineWidth = 2;
                        ctx.font = 'bold 24px Arial';
                        ctx.textAlign = 'center';
                        const text = photos[currentIndex].expressionName || 'Expression Practice';
                        ctx.strokeText(text, canvas.width / 2, 40);
                        ctx.fillText(text, canvas.width / 2, 40);
                    };
                    img.src = photos[currentIndex].dataUrl;
                    currentIndex++;
                }, 2000);
            });
        }
        
        // Show progress
        function showProgress(message, detail = '') {
            const overlay = document.getElementById('progressOverlay');
            const messageEl = document.getElementById('progressMessage');
            const detailEl = document.getElementById('progressDetail');
            
            messageEl.textContent = message;
            detailEl.textContent = detail;
            overlay.classList.add('show');
            
            console.log('Progress:', message, detail);
        }
        
        // Hide progress
        function hideProgress() {
            const overlay = document.getElementById('progressOverlay');
            overlay.classList.remove('show');
            console.log('Progress completed');
        }

        // Update video statistics
        function updateVideoStats(blob, trainingData) {
            // Simplified version - just ensure video can play normally
            console.log('Video generated successfully:', {
                size: `${(blob.size / (1024 * 1024)).toFixed(2)} MB`,
                photos: trainingData.photos || 5
            });
        }

        // Set up event listeners
        function setupEventListeners() {
            // Video playback control
            const videoElement = document.getElementById('recordedVideo');
            const overlay = document.getElementById('videoOverlay');
            
            overlay.addEventListener('click', function() {
                videoElement.play();
                overlay.classList.add('playing');
            });
            
            videoElement.addEventListener('pause', function() {
                overlay.classList.remove('playing');
            });
            
            videoElement.addEventListener('ended', function() {
                overlay.classList.remove('playing');
            });
            
            // Download button
            document.getElementById('downloadBtn').addEventListener('click', downloadVideo);
            
            // Share button
            document.getElementById('shareBtn').addEventListener('click', shareVideo);
            
            // WeChat share button
            document.getElementById('wechatBtn').addEventListener('click', shareToWechat);
        }

        // Download video
        function downloadVideo() {
            if (!videoBlob) {
                showError('No video available for download');
                return;
            }
            
            showLoading();
            
            setTimeout(() => {
                try {
                    const timestamp = new Date().toISOString().slice(0, 19).replace(/[-:]/g, '').replace('T', '_');
                    const filename = `facial_expression_training_${timestamp}.webm`;
                    
                    const downloadLink = document.createElement('a');
                    downloadLink.href = videoUrl;
                    downloadLink.download = filename;
                    downloadLink.style.display = 'none';
                    
                    document.body.appendChild(downloadLink);
                    downloadLink.click();
                    document.body.removeChild(downloadLink);
                    
                    hideLoading();
                    showSuccess('Video download successful!');
                } catch (error) {
                    console.error('Download failed:', error);
                    hideLoading();
                    showError('Download failed, please try again');
                }
            }, 1000);
        }

        // Quick share
        async function shareVideo() {
            if (!videoBlob) {
                showError('No video available for sharing');
                return;
            }
            
            // Check if Web Share API is supported
            if (navigator.share && navigator.canShare) {
                try {
                    showLoading();
                    
                    // Create file object
                    const timestamp = new Date().toISOString().slice(0, 19).replace(/[-:]/g, '').replace('T', '_');
                    const filename = `facial_expression_training_${timestamp}.webm`;
                    const file = new File([videoBlob], filename, { type: 'video/webm' });
                    
                    if (navigator.canShare({ files: [file] })) {
                        await navigator.share({
                            title: 'My Facial Expression Training Video',
                            text: 'Check out my facial expression training results!',
                            files: [file]
                        });
                        
                        hideLoading();
                        showSuccess('Share successful!');
                    } else {
                        // Fallback to link sharing
                        await navigator.share({
                            title: 'My Facial Expression Training Video',
                            text: 'Check out my facial expression training results!',
                            url: window.location.href
                        });
                        
                        hideLoading();
                        showSuccess('Share link copied!');
                    }
                } catch (error) {
                    hideLoading();
                    if (error.name !== 'AbortError') {
                        console.error('Share failed:', error);
                        copyToClipboard();
                    }
                }
            } else {
                // Does not support Web Share API, copy link to clipboard
                copyToClipboard();
            }
        }

        // Copy link to clipboard
        async function copyToClipboard() {
            try {
                const shareText = `🎭 Check out my facial expression training results!\n\nThrough the Facial Expression Coach app, I have mastered professional expression techniques. Come train together!\n\n${window.location.origin}`;
                
                await navigator.clipboard.writeText(shareText);
                showSuccess('Share text copied to clipboard!');
            } catch (error) {
                console.error('Copy failed:', error);
                showError('Copy failed, please manually copy the link');
            }
        }

        // WeChat share
        function shareToWechat() {
            showLoading();
            
            setTimeout(() => {
                hideLoading();
                
                // Show QR code area
                const qrSection = document.getElementById('qrSection');
                qrSection.style.display = 'block';
                
                // Generate share QR code
                generateQRCode();
                
                // Smooth scroll to QR code area
                qrSection.scrollIntoView({ behavior: 'smooth' });
            }, 1500);
        }

        // Generate real QR code
        async function generateQRCode() {
            const qrCode = document.getElementById('qrCode');
            
            try {
                // Get current page URL as share link
                const currentUrl = window.location.href;
                
                // Generate QR code
                const canvas = document.createElement('canvas');
                await QRCode.toCanvas(canvas, currentUrl, {
                    width: 120,
                    height: 120,
                    color: {
                        dark: '#6B46C1',  // Purple QR code
                        light: '#FFFFFF'  // White background
                    }
                });
                
                // Clear and add QR code
                qrCode.innerHTML = '';
                qrCode.appendChild(canvas);
                
                // Add tip text
                const tip = document.createElement('div');
                tip.style.cssText = 'font-size: 12px; color: #666; text-align: center; margin-top: 10px;';
                tip.textContent = 'Scan with WeChat to share to Moments';
                qrCode.appendChild(tip);
                
                console.log('QR code generated successfully');
            } catch (error) {
                console.error('QR code generation failed:', error);
                qrCode.innerHTML = `
                    <div style="font-size: 12px; color: #666; text-align: center;">
                        <div style="color: #ff6b6b; margin-bottom: 10px;">⚠️ QR code generation failed</div>
                        <div>Please copy the link directly to share:</div>
                        <div style="word-break: break-all; background: #f5f5f5; padding: 8px; border-radius: 4px; margin-top: 8px; font-size: 10px;">
                            ${window.location.href}
                        </div>
                    </div>
                `;
            }
        }

        // Show loading state
        function showLoading() {
            document.getElementById('loadingSection').style.display = 'block';
        }

        // Hide loading state
        function hideLoading() {
            document.getElementById('loadingSection').style.display = 'none';
        }

        // Show success message
        function showSuccess(message) {
            const successElement = document.getElementById('successMessage');
            successElement.querySelector('span:last-child').textContent = message;
            successElement.style.display = 'block';
            
            setTimeout(() => {
                successElement.style.display = 'none';
            }, 3000);
        }

        // Show error message
        function showError(message) {
            alert('❌ ' + message);
        }

        // Clean up resources when page unloads
        window.addEventListener('beforeunload', function() {
            if (videoUrl) {
                URL.revokeObjectURL(videoUrl);
            }
        });
    </script>

    <!-- Progress overlay -->
    <div class="progress-overlay" id="progressOverlay">
        <div class="progress-content">
            <div class="progress-spinner"></div>
            <div class="progress-message" id="progressMessage">Processing...</div>
            <div class="progress-detail" id="progressDetail">Please wait</div>
        </div>
    </div>
</body>
</html>